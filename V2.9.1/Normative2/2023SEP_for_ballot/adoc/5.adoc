== 5.2 INTRODUCTION

This chapter defines the rules that apply to queries and to their responses. It also defines the unsolicited display messages because their message syntax is query-like in nature.

Version 2.4 of the standard introduced new models for query and response messages. The layout of this chapter is structured such that all information pertaining to those newly defined query/response message pairs, including auxiliary protocols, appears in sections 5.2–5.9 and the previously defined queries appear in section 5.10. Outstanding issues appear in the final section, 5.11.

[width="100%",cols="75%,25%",options="header",]
|===
|Topic |Section Reference
|Introduction |5.2
|Query/Response Model |5.2.1
|Evolution of the Query Standard |5.2.2
|Query Development Methodology |5.2.3
|Response Formats |5.2.4
|Query Specification Formats |5.2.5
|Summary Chart of Query/Response Pairs |5.2.6
|Query/Response Profile |0
|Query/Response Message Pairs |5.3.3.4
|Query/Response Message Segments |0
|Auxiliary Query Protocols |5.6
|Publish and Subscribe |5.7
|Query Implementation Considerations |5.8
|Query/Response Message Examples |5.9
|Superseded Query/Response Trigger Events and Message Pairs |5.10
|Display Messages |5.10.1
|Original Mode Queries |5.10.2
|Outstanding Issues |5.11
|===

The Standard embraces the most common queries that are likely to occur. These are defined by the functional chapters. The following represents typical examples of queries supported by the Standard:

{empty}a) data regarding a single patient, e.g., send all lab results for patient #123456

{empty}b) data regarding multiple patients, e.g., send the list of patients whose attending physician is Dr. #123

{empty}c) data that is not patient related, e.g., send the age specific normal values for serum protein.

{empty}d) data within a specified time range, e.g., send all serum glucose results, reported between January 1, 1998 through December 31, 1999, for patient #123456.

The variety of potential queries is almost unlimited. There was no attempt here to define a Standard that would cover every possible query. Chapter 5 discusses general ways query/response pairs are structured. Functional chapters discuss specific query/response pairs required for their needs. The technical committees responsible for functionally-specific chapters define detailed content of the query/response segment patterns within those chapters.

In particular, there is no implication that a specific system SHALL support generalized queries or Conformance Statements to comply with the Standard. Rather, these transactions provide a format, or a set of tools to support queries to the extent desired by the institution. The resources available and local policies will influence the type of queries that MAY BE implemented.

=== 5.2.1 Query/response model

A query with its response should be thought of as a message pair. The following illustration shows the three generic models of message pairs: the *_declarative, interrogative,_* and *_imperative_*. Within each model, one system assumes the role of initiator and the other system assumes the role of responder. HL7 queries follow the "interrogative" style of messaging as described below.

image:extracted-media/media/image1.wmf[extracted-media/media/image1]

*Note:* All messaging in HL7 assumes a single basic paradigm using a point-to-point transmission of an initial message from a sender to a receiver, followed by a response or acknowledgement message from the receiver back to the sender. The response/acknowledgment message may be optional depending on several use cases that will be discussed below. The point-to-point transmission is defined independent of any particular technology or architecture.

The *_declarative_* model is employed for distribution or broadcast of unsolicited *events* such as the ORU and RDS. *Clients* (*interested parties*) that desire information that resides on a *Server* or *data owner* may "subscribe" to be updated when new information is available on the Server. The Server initiates a transmission of event information. This transmission may be to a single Client, or may be a broadcast to multiple Clients. Each Client responds with an acknowledgement of receipt.

The *_interrogative_* model is employed for queries. A Client initiates a query (a request for data) to the Server. The Server processes the query, responds with a report of success or failure of the query to the Client, and further responds by delivering information requested by the query.

The *_imperative_* model is employed for remote interoperation. A Client initiates a request for action (such as an order) to the Server. The Server processes the request and responds with a report of success or failure to the Client.

*Note:* In HL7 v2, there is no formal assumption of client-server architecture, or of a particular "publish and subscribe" architecture. Thus the roles of the intercommunicating applications may change according to the messaging needs. _i.e._, an application may be a data owner or Server for one set of messages (e.g., an order entry system creating orders), and an interested party or Client for another set of messages (e.g., an order entry system receiving order status messages from an ancillary departmental system). Furthermore, the "data owning" system may be a middleware component such as an "application server" or a "messaging gateway" or "router" that distributes information from a server application. In the discussions below, "_Client_" and "_Server_" are used as shorthand synonyms for "requesting system/application" and "responding system/application" without implying the assumption of a client/server architecture. Likewise, the support for "publish and subscribe" does not assume a particular operating system or architecture, but is defined at the application level (level 7), in a technology-neutral form. The phrase "_data owner_" is used to refer to the human institution that operates the Server program. One would say that "the data owner defines the data to be made available by the Server program."

=== 5.2.2 Evolution of the query standard

The Query Standard, like the HL7 Standard in general, has been evolving since its inception in Version 2.1. Version 2.4 introduced a new methodology intended to supersede the previous generation of queries.

*Original Mode Queries*

Originally, the parameters of an HL7 query were carried by the QRD and QRF segments. Because these segments were intended to be used by all queries, the content of these segments could only be loosely defined. Such "original mode queries" actually represent just a starting point for defining queries.

In these original mode queries, separate trigger events were used to differentiate between an immediate response and a deferred response. In addition, some of the functional chapters defined queries and responses with separate trigger events.

*Enhanced Mode Queries*

In HL7 v 2.3, "enhanced mode queries" were introduced that attempted to provide for a much higher level of precision in queries. Four new ways of specifying a query were introduced in Version 2.3.

An Embedded Query Language query, which supports free-form select statements, based on the query language of choice (e.g., SQL)

a Virtual Table request query which supports queries against server database tables (virtual or actual) based on specific selection criteria

a stored procedure request, which enables an application on one system to execute a stored procedure on another system, which is coded to extract specific data

an event replay request message, which is used to request data formatted as an event replay response

"Enhanced Mode" introduced three new ways to pass data to the responding system (e.g., a Server).

____
{empty}1) Passing values to specific parameters of a query. (Used by the stored procedure and event replay queries.) This is the most common and straightforward technique for creating queries. The drawback is that the client is tightly limited in the range of queries it can formulate.

{empty}2) Passing the query as a single complex query "expression". (Used by the Virtual Table query.) The query is defined by an expression-tree made up of the usual AND OR, '<' , '>', ... Operators can refer to column names or variables defined by the Server. These Queries give the Client significant flexibility in specifying their query over the columns that the Server has permitted. The cost of this Client flexibility is that the Server SHALL evaluate the query expression, rather than simply plug parameter values into an existing stored procedure.

{empty}3) Passing the query as a single string in an existing database query language such as SQL. (Used by the EQL External Query Language query.) An EQL query is represented as a string formatted in the particular syntax of an existing query language. The Server will probably pass this string expression directly to an existing database engine to evaluate the query, which will have to parse this expression to recover the query. The drawback of this technique is that different database engines use different query languages, and so the exact query string which the Client constructs will depend on the Server's query language.
____

Also in Version 2.3, the use of the trigger event was moving closer to the definition set forth in chapter 2. Each offered query had its own trigger event. In Version 2.3.1 each response had its own trigger event.

*Version 2.4 Queries*

Users of v 2.3 queries encountered some somewhat arbitrary limitations suggested by the v 2.3 standard. A close reading of the v 2.3 virtual table query wording made it appear that the only way a query could be specified by a QSC selection expression was if it returned tabular (RDT) results, and it seemed that query-by-parameter queries could not return tabular results.

Versions of the HL7 standard after v 2.3.1 more cleanly separate how a query is specified from how the data is returned, and they emphasize the existence of a "Conformance Statement." HL7 continues to support the semantics of the Stored Procedure/Event Replay queries and the Virtual Table queries, but formulates the syntax more clearly using a single new query, the Query By Parameter (QBP).

The QBP query is intended to unify the semantics of the stored-procedure, event-replay and virtual-table queries within the framework of a precise conformance statement.

The standard recognizes the continued use of the Original Mode queries (QRD/QRF), but uses a new query formalism to explain their semantics more clearly.

The bulk of the new material after Version 2.3.1 consists of defining a format for Conformance Statements, and giving examples of query design and use.

*Note:* Version 2.5 introduced a new, use-case-based mechanism for conformance in Section 2.12 of Chapter 2. Query implementers are encouraged to review and, where appropriate, adopt the profiling structures outlined in that section. Conformance Statement structures introduced in Version 2.4 have been renamed Query Profiles.

*Compatibility with past versions*

For backward compatibility, both the "original" and "enhanced" queries remain in the standard, but their description has been relegated to a "for backward compatibility only" section. The main part of this chapter is a complete and consistent explanation of the recommended approach to HL7 queries in Version 2.4 and later.

As in versions of the standard prior to 2.4, the detailed domain content of the query and response messages is defined by the technical committees responsible for the functionally-specific chapters; the basic forms and methodology for queries and responses are defined in this chapter.

Sections _5.2.4_, "_Response format_," and _5.2.5_, "_Query specification formats_," discuss Response Formats and Query Specification Formats.

=== 5.2.3 Query development methodology

Typically, an individual HL7 conformant query would evolve as follows:

An institution, or data owner, decides that it would like to make information available via a query. It decides precisely what data will be made available and how it will be offered. Knowing its own data, the data owner will define its query to return one of three representations of the data:

____
{empty}1) As traditional HL7 segments. (See section _5.2.4.1_, "_Segment pattern response_.")

{empty}2) As rows and columns of data from a precisely defined Virtual Table. (See section _5.2.4.2_, "_Tabular response_.")

{empty}3) As rows of human readable text ready to output to a screen or printer. (See section _5.2.4.3_, "_Display response_.")
____

Next, the data owner specifies exactly which input variables the Client can use to control the data that the Server agrees to return.

The complete specification of what data are available, how the data will be returned, and what variables can be valued or constrained in a Query is called the Query Profile.

The Query Profile concept is critical to the proper usage of the query/response pair. In the absence of a Query Profile, the Client would be unaware of the existence of the query, let alone how to use it or what to expect from it**_._** The data owner advertises the existence of, and support for, a query by publishing a *_Query Profile_*.

The Query Profile has the following broad structure:

[width="100%",cols="100%",]
|===
|Introduction including title, trigger events, mode, characteristics and purpose
|Query Grammar
|Response Grammar
|Input Specification and Commentary
|Response Control
|Output specifications and Commentary
|===

*Query Profile*: A declaration which sets forth the name of the query supported by the Server, the logical structure of the information that can be queried, and the logical structure of what can be returned.

Section 0, "_Note that the_ Vaccination Query related messages have been removed as these were deprecated and withdrawn as of v 2.8.

Acknowledgment Choreography

As of Version 2.9 Infrastructure and Messaging requires that Acknowledgment Choreography be explicitly specified in MSH-15 and MSH-16. Because of the nature of the Query and Response Messaging pattern, the Response message is always an Application Acknowledgment. To specify this, the value in MSH-16 SHALL always be “AL” to indicate that there will always be an Application Acknowledgment to the Query Message. See Chapter 2 for more details on this subject.

QUERY/RESPONSE PROFILE," will explain the Query Profile in detail.

The next section elaborates on the three styles of response data (segment pattern, tabular, and display) that a data owner may use to represent its data.

The introduction of the Query Profile concept is not intended to imply system certification. It is intended to promote well-specified queries. As in previous versions, support for queries is not required for HL7 conformance.

=== 5.2.4 Response format

The first decision a data owner SHALL make in formulating a query is to decide which style of representing data is most appropriate for their needs.

[width="100%",cols="19%,81%",]
|===
|HL7 recognizes three main styles of representing responses to queries: *_tabular, segment pattern, or display_*. _Segment pattern_ and _tabular_ were previously known as _record-oriented_ as described in earlier versions of this Standard. _Segment pattern_ responses consist of a set of HL7 segments. Each query will define, in its Query Profile, the precise grammar of HL7 segments that it will return. Tabular responses return data as a set of rows, one RDT segment per row. Display queries return data in DSP segments. An HL7 conformant system interested in supporting queries will choose one or more of these styles before proceeding with a detailed design. |
|Tabular |The responding system formats the data in a relational format, as rows and columns.
|Segment pattern |The responding system formats the data on the basis of an application-specific segment-oriented (record-oriented) message.
|Display |The responding system formats the data in human readable format for direct outputting to a display device (in both original and enhanced modes).
|===

These structures support all original mode and enhanced mode responses, as well as the Conformance Based Queries.

==== 5.2.4.0 hiddentext

==== 5.2.4.1 Segment pattern response

Segment Pattern data responses reflect the traditional way of offering data within HL7. The Server responds to queries by returning a pattern of HL7 segments. For example, the core of a response to a query for Lab data might be defined by the following segment grammar:

\{PID

OBR

{empty}[\{OBX}]

}

For example, patient information will be returned in the PID segment and laboratory results in OBR and OBX segments. In this style, the message returned by a Server is often a close approximation to an existing unsolicited update HL7 message.

In creating a Query Profile for a segment pattern response, the data owner SHALL decide on the exact segment grammar it will return. The output specification of the Query Profile for a segment pattern response will have a structure very similar to the message definition of a standard HL7 transaction. It SHALL define a grammar of segments that will be returned, and, for each segment, it should clarify, where necessary, the meaning of each field, the cardinality of the data, and whether the data is optional or required.

==== 5.2.4.2 Tabular response

A data owner may decide that the best model for the data it wishes to offer is that of a fairly conventional table of rows and columns. In this case, a data owner advertises support for a straightforward ("virtual") table of data, with specific columns of specific data types. It further indicates which of the columns the Client can constrain in its query. The response to a query will be in the form of a set of rows from the advertised table.

The Virtual Table is an abstraction around a traditional database table. However, there are important differences between a traditional database table and the Virtual Table. The Virtual Table need not be based on a single table or collection of data. It may represent a "join" or combination of data among database tables (although the "join" or combination is not explicitly exposed to the Client).

The concept of _table,_ borrowed from the relational database world, is used merely as a representational aid. The actual internal data structure of the Server need not be relational. Virtual Tables may be used to present data elements from internal structures that are hierarchical, object-oriented, or otherwise non-relational in nature.

Virtual Tables therefore insulate the user from the exact data layout or representation in the data source. That is to say, the requestor need not understand the structure of the tables, rows and columns of the database being queried but only the structure of the Virtual Table representation. Likewise, the responder (database owner) does not have to expose the structure of the real database. Neither the owner nor the requestor needs to worry if the structure of the database changes.

The rows and columns of the Virtual Table for a query are fully described in the Query Profile for that query.

A virtual table data representation is appropriate when the information being offered is relatively simple. It would not be the appropriate representation for lab reports that typically involve a complex nesting of results into sections. Data carried by the typical HL7 segment or segment group could be modeled as a virtual table. For example, the ADT system might offer a table consisting of the fields of PID, NK1 and a single PV1 segment. On the other hand, it would be difficult to represent the visit history of a patient in a single virtual table.

==== 5.2.4.3 Display response

A display message can be generated where the update information does not need to be captured by the receiving system's database, but only displayed, either on a visual medium (such as a PC, workstation or a CRT) or on printed medium.

The display response does not actually represent a formal style of data organization. It represents a decision to return data formatted for human, rather than for computer, consumption. The Server offers a pretty-printed version of the data in a format that is meaningful for human readers. Logically, the content of the pretty-printed message might be the complex data carried by an HL7 segment pattern, or could be a simple record normally carried by a tabular response.

==== 5.2.4.4 Choosing among available response formats

In practice, it is easy to decide which style of data to offer. In general, segment pattern responses are able to carry complex data structures (e.g., an entire laboratory report) while tabular responses are typically simple data structures. Therefore, tabular response is intended as a simpler tool to accomplish a simpler task. There is no need for the Client to understand, parse and process the deep structure and relationships implied by the segment pattern response. The Client does not need a complex state machine to do segment level parsing. The rows all have the same structure so only a simple state machine is needed.

If the query is defined by an HL7 technical committee, then the decision is already made. If, on the other hand, no query is yet defined but the domain of the data is well covered by HL7, then it is probable that there are existing HL7 segments that could carry the data. A Z query may be constructed out of the existing HL7 segments. If the data is site specific, the site can either create its own Z segments and offer a segment pattern response (which makes particular sense if the overall data is complex) or it can define its own Virtual Table, offer a tabular response and let the Client process each record.

Once it is known what data a Server is making available, then the data can be ordered or requested. This is analogous to needing to refer to a catalog before ordering an item by mail.

=== 5.2.5 Query specification formats

The previous section explained the three representations for data that are returned to a query client. This section discusses how the client may represent a query for information.

HL7 now recommends one primary way with 3 basic variants for specifying a query.

This query model with its variants is intended to assist implementers in translating specific query needs from the ordinary prose of the business model into an appropriate HL7 query paradigm. The paradigm selected will depend upon the philosophy of the institution: whether to allow relative freedom to client systems in composing query expressions, or to control rigidly the fields and operations to be offered. The following paragraphs compare and contrast the features of each of the HL7 query variant models. The differences between them lie mainly in the processing they require on the Server side.

*_Query by Simple Parameter_*

____
The first variant is called the Simple Parameter query. In the simple parameter query, the input parameters are passed in order as successive fields of an HL7 segment. The Server need only read them from the corresponding HL7 fields, and plug them into an internal function to evaluate the query.

This is the most basic form of the query in which the Server specifies a fixed list of parameters in its Query Profile. (For example, the Server may direct the querying system to specify a medical record number, a beginning date, and an ending date.) When invoking the query, the Client passes a specific value for each parameter. This is analogous to invoking a stored procedure against a database.

The parameter definition segment (i.e., the QPD) can be seen as a generalization of the QRD and QRF segments of the original mode query. Each field in the QRD and QRF corresponds to 1 parameter of the QPD instance. HL7 recommends that queries defined by QRD and QRF segments be recast as a version 2.4 or later Query By Parameter.

The obvious implementation gain is that the Server can simply map the input values to the parameters specified in the Query Profile. An already known function or procedure is called to evaluate the query and select data to be returned. The bulk of the work effort has already been invested in the development of this predefined function or procedure.
____

*_Query by Example Variant:_*

____
The Query by Example (QBE) is an extension of Query by Parameter (QBP) in which search parameters are passed by sending them in the segment which naturally carries them, instead of as fields of the QPD segment. For example, if one wanted to perform a "find_candidates" query using QBE, one would send the demographics information on which to search in the PID and/or PD1 segments, leaving blank those fields in the segment sent that are not query parameters. If, for example, religion were not one of the query parameters, PID-17 would be left blank when the PID was sent in the query. Parameters which do not occur naturally in an HL7 message, such as search algorithm, confidence level, etc., would continue to be carried in the QPD segment as they are in the Query by Parameter. The exact segments and fields available for use as query parameters would be specified in the Query Profile for the query.
____

*_Query Using the QSC Variant:_*

____
The third variant is known as the QSC variant because of its use of the QSC data type, which was used in the Virtual Table query. The Query Profile for the query will define all the variables that the Client may use in an expression. At runtime, the Client is able to define the exact search criteria by constructing a "tree" of operator/operand nodes that constrain the available input parameters. To evaluate the query, the Server SHALL be willing to analyze and interpret the query expression at runtime. The Server may translate the input expression into its local data access language, or perhaps it will interpret the request itself, and evaluate the expression for each item of the virtual table. The client's Complex Expression is analogous to an SQL selection statement against a relational database.

This variant is most like the Virtual Table Query (VQQ).
____

There are a number of factors to consider in determining which variant to offer. In the Complex Expression (QSC) variant, the Client may select any or all of the variables offered and may specify any permissible operators and values for each variable. By contrast, in the Simple Parameter variant or the Query by Example variant, the Client SHALL provide values for exactly the set of variables offered.

____
The Simple Parameter variant is easy to parse and process because it has positional fields; i.e., the parameters are in a predefined and fixed order. Likewise, the Query by Example variant lends itself to simple processing, since parameters will occur in known positions in defined segments. The Complex Expression variant, on the other hand, requires more involved parsing and processing because of its flexibility and the optionality of its elements. Thus, while the Complex Expression variant offers more functionality to the Client, it is more burdensome for the Server to process. Conversely, the Simple Parameter and Query by Example variants offer less functionality to the Client but are generally easier for the Server to implement; they are often based on existing stored procedures on the Server's system.
____

==== 5.2.5.0 hiddentext

==== 5.2.5.1 Expressing the same data using the variants

The following is an example of a query stated in all three variant forms. This example is presented to illustrate the utility of each format for the purpose of offering a query. Which format to use depends upon the level of processing complexity to be implemented on the Server and the degree of specification flexibility required by the Client.

The purpose of the query is to allow a simple inquiry upon an administrative database. Suppose a patient information request is submitted by the Client. The Server is to respond with demographic information: patient's date of birth, sex, and ZIP code.

===== 5.2.5.1.1 Expression as simple parameters

As we have seen, this variant requires an exact parameter specification.

The client system transmits a QBP query message in the following format:

MSH|^~\&|FEH.IVR|HUHA.CSC|HUHA.DEMO||199902031135-0600||QBP^Z58^QBP_Q13|1|D|2.8

QPD|Z58^Pat Parm Qry 2|Q502|111069999

RCP|I

The names of the input and output fields are not specified in the query message, but by the Query Profile, identified by _QPD-1-message query name_. The _MSH-9.2-trigger event_ and the _QPD-1-message query name_ are this query's only distinguishing elements. The requesting system SHALL refer to this query's Query Profile to learn more about the input and output fields.

===== 5.2.5.1.2 Expression as query by example

Just as in the Simple Parameter variant, the Query by Example requires an exact parameter specification. The distinction in a Query by Example is that segments other than QPD are used to transmit the parameters. The segments offered should be already-existing segments that the Server can parse easily.

The client system transmits a Query by Example in the following format.

MSH|^~\&|FEH.IVR|HUHA.CSC|HUHA.DEMO||199902031135-0600||QBP^Z58^QBP_Q13|1|D|2.8

QPD|Z58^Pat Parm Qry 2|Q502

RCP|I

Parameters used in this query are specified in the Query Profile.

===== 5.2.5.1.3 Expression as a complex expression

In contrast, the Complex Expression variant allows flexible input specifications. This allows more choices for the Client system, but can require more complex processing capability on the part of the Server System.

If the above Simple Parameter variant were to be stated as a Complex Expression, it might look like this.

MSH|^~\&|FEH.IVR|HUHA.CSC|HUHA.DEMO||199902031135-0600||QBP^Q13^QBP_Q13|1|D|2.8

QPD|Z999^Pat Sel Qry 1|Q501|@MedicalRecordNo^EQ^111069999

RCP|I

Note the explicit statement of the input field name in _QPD-3-user parameters_. Also, note that this query might be used to specify and request other fields, depending upon the specification of what is permitted by the server system's Query Profile.

[width="100%",cols="36%,64%",]
|===
|Query Modalities |
|Simple Parameter Variant |The Server specifies parameters and the Client passes specific values to the parameters when the query is invoked.
|Complex Expression Variant |The Server offers variables which can be used by the Client who passes a constraining expression (subject to any limitations specified by the Query Profile) over those variables when invoking the query.
|===

Using the new modalities shown in the table, the variety and number of queries is almost unlimited. There is no implication that a specific Server must support all of these potential generalized queries to comply with the Standard. Rather, these transactions provide a format, or a set of tools, to support queries to the extent desired by the institution. The resources available and local policies will influence the types of queries that are implemented.

=== 5.2.6 Summary chart of query/response pairs

The following chart delineates the query/response messages defined in chapter 5:

[width="100%",cols="25%,11%,12%,21%,16%,15%",options="header",]
|===
|Description |Query |Response |Response type |Defining segment(s) |Sec Ref
|Cancel query |QCN | | | |5.4.6
|Query By Parameter |QBP | | |QPD |5.4.1, 5.4.2, 5.4.3
|Query, original Mode (withdrawn) |QRY | |Original mode (withdrawn) |QRD/QRF |
|Display response | |RDY |Display |DSP |5.4.3
|Response Segment Pattern | |RSP |Segment pattern | |5.4.1
|Response tabular | |RTB |tabular |RDF/RDT |5.4.2
|Unsolicited display message (withdrawn) |UDM | |Display (withdrawn) |URD/URS |
|===

The following chart delineates the query/response messages defined in the functional chapters:

[width="100%",cols="24%,12%,12%,21%,16%,15%",options="header",]
|===
|Description |Query |Response |Response type |Defining +
segment(s) |Sec Ref
|ADT response (withdrawn) |QRY^A19 |ADR^A19 |Original mode (withdrawn) |QRD/QRF |
|Allocate identifiers |QBP^Q24 |RSP^K24 |Segment pattern |QBP |3.3.59
|Ancillary RPT (display) (for backward compatibility only) | |ARD |Original mode | |7
|Find candidates |QBP^Q22 |RSP^K22 |Segment pattern |QBP |3.3.57
|Get corresponding identifiers |QBP^Q23 |RSP^K23 |Segment pattern |QBP |3.3.58
|Get person demographics |QBP^Q21 |RSP^K21 |Segment pattern |QBP |3.3.56
|Order status query/ Order status response (withdrawn) |OSQ^Q06 |OSR^Q06 |Original mode (withdrawn) |QRD/QRF |
|Pharmacy administration information (withdrawn) |QRY^Q27 |RAR^RAR |Original mode (withdrawn) |QRD/QRF |
|Master files query |MFQ | |Original mode | |8.4.3
|Master files query response | |MFR |Original mode | |8.43
|Personnel information |QBP^Qnn |RSP^Knn |Segment pattern |QBP |15.3.7
|Pharmacy dispense information (withdrawn) |QRY^Q28 |RDR^RDR |Original mode(withdrawn) |QRD/QRF |
|Pharmacy dose information (withdrawn) |QRY^Q30 |RGR/RGR |Original mode (withdrawn) |QRD/QRF |
|Pharmacy encoded order information (withdrawn) |QRY^Q29 |RER^RER |Original mode (withdrawn) |QRD/QRF |
|Pharmacy prescription order response (withdrawn) |QRY^Q26 |ROR^ROR |Original mode (withdrawn) |QRD/QRF |
|Request clinical information (withdrawn) |RQC^I05 | |Original mode (withdrawn) |QRD/QRF |
|Results of observation, query for (withdrawn) |QRY^R02 |ORF^R04 |Original mode (withdrawn) |QRD/QRF |
|Return Clinical Information (withdrawn) | |RCI^I05 |Original mode (withdrawn) |QRD/QRF |
|Return Clinical List (withdrawn) | |RCL^I06 |Original mode (withdrawn) |QRD/QRF |
|Return patient referral |RRI | |Original mode | |11.5
|Return patient referral | |RRI |Original mode | |11.5
|Schedule query |SQM | |Original mode | |10.5.3
|Schedule query response | |SQR |Original mode | |10.5.3
|===

Note that the Vaccination Query related messages have been removed as these were deprecated and withdrawn as of v 2.8.

=== 5.2.7 Acknowledgment Choreography

As of Version 2.9 Infrastructure and Messaging requires that Acknowledgment Choreography be explicitly specified in MSH-15 and MSH-16. Because of the nature of the Query and Response Messaging pattern, the Response message is always an Application Acknowledgment. To specify this, the value in MSH-16 SHALL always be “AL” to indicate that there will always be an Application Acknowledgment to the Query Message. See Chapter 2 for more details on this subject.

== 5.3 QUERY/RESPONSE PROFILE

The introduction of the Query/Response Profilefootnote:[Formerly known as the Conformance Statement, this artifact will be referred to throughout the rest of this document as the *Query Profile* to distinguish it from an implementor assertion of conformance to a particular profile. The Query Profile is understood to include the definition of the appropriate response message(s).] concept is not intended to imply system certification. It is intended to promote the definition and implementation of well-specified queries. As in previous versions, support for queries is not required for HL7 conformance.

In the introduction, the data owner describes the data being made available and the purpose of the query. He specifies the exact coded value for the Query Name which the Client SHALL use to invoke this query.

The Query Grammar defines the exact segments the Client MAY send. For each field of those segments, the Query Profile SHALL define how the Server will interpret client values. (For example, the patient name field is interpreted as a regular expression match.)

The Response Grammar defines the exact pattern of segments that the Server will return. Each Segment Pattern Response will specify its own pattern of segments. (For example, lab data queries will return patterns of OBR and OBX, while demographic queries might respond with patterns of PID, PV1,... segments.) When a data owner defines a tabular response query, the response grammar might simply be a list of RDT segments that carry rows of data. The user selects columns from a Virtual Table to define the output for the Query by Parameter/Tabular Response (QBP/RTB).

Note that in the case of an HL7-defined query, a specific section of the HL7 Standard will define a Query Profile. By contrast, in the case of a site defined query, the Query Profile is written by analysts and programmers of the Server application/system, and is available to the analysts and programmers of the Client application/system.

Although the Query Profile was a new construct with Version 2.4, it may also be used with the previous generation queries.

*Note:* Version 2.5 introduced a new, use-case-based mechanism for conformance in Chapter 2. Query implementers are encouraged to review and, where appropriate, adopt the profiling structures outlined in that chapter. Current Query Profile structures are retained in Chapter 5 pending revision to the new structures in the next version of the Standard.

=== 5.3.1 Using the Query Profile

Critical to the proper usage of the new query/response pairs is the Query Profile concept. In the absence of a Query Profile, the Client might not be aware of the existence of a query, or might not know how to use it or what to expect from it.

The Server advertises the existence of, and support for, a query by publishing a *_Query Profile_*. The Query Profile identifies the query, specifies what items can be queried and describes what the response will look like.

*Query Profile:* A declaration which sets forth the name of the query supported by the Server, the logical structure of the information that can be queried, and the logical structure of what can be returned.

A number of examples of Query Profiles can be found in section _5.9_, "_QUERY/RESPONSE MESSAGE EXAMPLES_."

==== 5.3.1.0 hiddentext

==== 5.3.1.1 Query with tabular response example

The user wishes to know the identity of the patient whose medical record number is "555444222111".

MSH|^~\&|PCR|GenHosp|MPI||199811201400-0800||QBP^Q40^QBP_Q13|8699|P|2.8||||||||

QPD|Q40^WhoAmI^HL7nnnn|Q0001|555444222111^^^MPI^MR|||19980531|19990531|

RCP|I|

RDF|6|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

The MPI system returns the following RTB message

MSH|^~\&|MPI|GenHosp|PCR||199811201400-0800||RTB^K13^RTB_K13|ACK9901|P|2.8||||||||

MSA|AA|8699|

QAK|Q0001|OK|Q40^WhoAmI^HL7nnnn|1|

QPD|Q28^WhoAmI^HL7nnnn|Q0001|555444222111^^^MPI^MR|||19980531|19990531|

RDF|6|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

RDT|555444222111^^^MPI^MR|Everyman^Adam||19600614|M||

==== 5.3.1.2 Example of Query Profile with tabular response

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z99): |Z99
|Type: |Query (or Publish)
|Query Name: |Who Am I
|Query Trigger (= MSH-9): |QBP^Z99^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RSP^Z84^RSP_Z84
|Query Characteristics: |Returns response sorted by PatientLastName unless otherwise specified. Note that neither the PID nor the RDF segments are used.
|Purpose: |Find the identity of the patient for specified medical record number(s)
|Response Characteristics: |Returns response sorted by PatientLastName unless otherwise specified.
|Based on Segment Pattern: |
|===

QBP^Z99^QBP_Q13: Query Grammar: QBP Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ PID ] |Patient Identification Segment | |3.4.2
|[ link:#RDF[RDF] ] |Table Row Definition Segment | |5.5.6.6
|link:\l[RCP] |Response Control Parameter | |5.5.6
|[ RDF ] |Table Row Definition Segment | |5.5.6.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|QBP^Z99^QBP_Q13 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Z84^ACK
|Application Ack |RSP^Z84^RSP_Z84 |RSP^Z84^RSP_Z84 |RSP^Z84^RSP_Z84
|===

RSP^Z84^RSP_Z84: Response Grammar: RTB Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ ERR ] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.4.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.6.6
|[ \{ link:#RDT[RDT] } ] |Table Row Data Segment | |5.5.6
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="24%,37%,10%,29%",options="header",]
|===
|Acknowledgement Choreography | | |
|RSP^Z84^RSP_Z84 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |NE |NE
|Immediate Ack |- |- |ACK^Z84^ACK
|Application Ack |- |- |-
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z99) |Field Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |PatientList |S |Y |20 |CX |O | | | |PID-3 | |PID-3 Patient Identifier List
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z99) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z99^WhoAmI^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|PatientList | |CX |
| | | |Components: <ID (ST)> ^ <check digit (ST)> ^ <code identifying the check digit scheme employed (ID)> ^ < assigning authority (HD)> ^ <identifier type code (IS)> ^ < assigning facility (HD)>
| | | |The combination of values for _PatientID, and PatientIDAssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The PatientIDTypeCode is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |
| |ID |ST |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |Assigning Authority |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |Identifier Type Code |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,13%,6%,7%,36%",options="header",]
|===
|Field Seq (Query ID=Z99) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z99) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3: Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|Mother'sMaidenName | | |48 |XPN | | | | |PID.6 | |PID-6 Mother's Maiden Name
|DOB | | |24 |DTM | | | | |PID.7 | |PID-7 Date/Time of Birth
|Sex | | |1 |CWE | | | | |PID.8 | |PID-8 Sex
|Race | | |80 |CWE | | | | |PID.10 | |PID-10 Race
|===

=== 5.3.2 Formal specification of the Query Profile

The Query Profile contains the following information:

Query Profile ID: The unique identifier applying to this query's Query Profile. This value is transmitted as the first component of _QPD-1-Message query name_. For sites implementing the Conformance SIG's Implementation Guide, this value shall also be transmitted in _MSH-21-Query Profile ID_.

Formal Query Name: identifies a unique query or publication, e.g., PharmacyDispenseHistory.

Query Trigger: identifies the trigger event for the query. Note that more than one Query Profile may map to the same generic trigger event (Q10 through Q15). If a non-generic trigger event is used, it should correspond to exactly one Query Profile.

The use of Q for HL7-standard query trigger events is conventional; another letter may be used if the supply of Q triggers is exhausted.

The assignment of a trigger event, while mandatory, is intended to facilitate processing rather than to identify a query uniquely. A query is uniquely identified by the value transmitted in _QPD-1-Message query name_. This value SHALL be the same in both the query and response messages, even though the trigger event for the query differs from the trigger event for the response.

Response Trigger: identifies the unique trigger event for the response. Note that more than one Query Profile may map to the same generic trigger event (K10 through K15). If a non-generic trigger event is used, it should correspond to exactly one Query Profile.

The use of K for HL7-standard response trigger events is conventional; another letter may be used if the supply of K triggers is exhausted.

Query Priority: Specifies if the query is immediate, deferred or selectable.

Query Characteristics: Narrative describing general feature of the query.

Purpose: Describes intent of query.

Query Grammar: defines the logical structure of what can be sent by the Client. The structure of this part of the Query Profile is very similar in appearance to a message syntax.

Response Grammar: defines the logical structure of what can be returned by the Server. The structure of this part of the Query Profile is very similar in appearance to a message syntax with two additional columns: Comment and Support Indicator.

Data Model: the logical structure of the information that can be queried. It can be thought of as a set of rows or a list of items having the same format as the Virtual Table structure described in the next section. This works for both tabular and segment pattern queries. A display query can be considered as orthogonal to the tabular and segment pattern queries and follows the same input structure. This is not always included in the Query Profile.

Input Parameter Field Specification and Commentary: Cites the allowable parameters that can be passed to the recipient. The structure of this part of the Query Profile is very similar in appearance to an HL7 Segment Attribute Table with several additional columns: ColName, Key/Search, Sort, MatchOp, SegmentFieldName, and Service Identifier Code.

A QPD Input Parameters table and corresponding explanation table is always provided. These tables discuss all the fields of the QPD segment, including _QPD-1-Message query name_ and _QPD-2-Query tag_. If the query is a Query by Example, additional input parameters and explanation tables are provided for all the fields that may be populated in the example segments.

Response Control: Specifies execution date and time, restrictions on amount of data, and query modality. This is not always included in the Query Profile.

Output Specification and Commentary: Used for tabular and display response. For the tabular response, it specifies the column names that will be returned. The structure of this part of the Query Profile is very similar in appearance to an Attribute Table with several additional columns: ColName, Key/Search, Sort, MatchOp, SegmentFieldName, and Service Identifier Code. For the display response, it describes the format of the data that will be returned.

Note that in the case of an HL7-defined query, a specific section of the HL7 standard will define a Query Profile. The existence of a standard Query Profile for any given query does *not* mean that a system SHALL implement this particular query to be conformant to the HL7 Standard. However, systems that do implement the query SHALL follow the specifications as given in the Query Profile.

Sites that wish to offer queries not specified by the Standard may create their own Query Profiles. By contrast to an HL7-standard query, in the case of a site defined query, the Query Profile is written by the Server, and is available to the analysts and programmers of the Client system to enable them to know the exact behavior of the Server.

Although the Query Profile was a new construct with version 2.4, it may also be used with the previous generation queries.

Input Parameter Specification and Input Field Description and Commentary are always included for the QPD segment. When the Query by Example variant is used, they are provided for the QBE as well. An Output Specification and Commentary showing a Virtual Table is provided for queries that accommodate a tabular response.

For Query Profiles published in the HL7 Standard, each table includes the Query Profile ID in parentheses in the upper left-hand cell. This allows the table to be imported automatically into the HL7 database.

==== 5.3.2.0 hiddentext

==== 5.3.2.1 Steps for developing a Query Profile

____
{empty}1) Before composing the Query Profile, express the query in ordinary English sentences.

{empty}2) Transform the query into a mathematical or pseudo-language statement. A syntax such as SQL provides a useful mechanism.

{empty}3) From the pseudo-statement, extract the parameters and the operations upon the parameters.

{empty}4) Advertise the parameters in the Query Profile.

{empty}5) Within the Query Profile, explain the operations that will be performed upon the parameters: relational conjunctions, equality/inequality, etc. Use examples to aid the user in understanding how the query might be invoked in specific instances.
____

==== 5.3.2.2 Query Profile introduction

The Query Profile begins with a table that summarizes the characteristics and identifying information about the query to which the Query Profile applies.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Znn): |Znn
|Type: |
|Query Name: |
|Query Trigger (= MSH-9): |
|Query Mode: |
|Response Trigger (= MSH-9): |
|Query Characteristics: |
|Purpose: |
|Response Characteristics: |
|Based on Segment Pattern: |
|===

*Query Statement ID*: The unique identifier applying to this Query Profile. This value is transmitted as the first component of _QPD-1-Message query name_.

*Type*: Usually *Query*, except for publish-and subscribe Query Profiles (see section _5.7.3.1_, "_Example of a publish and subscribe Query Profile_") for which the value should be *Publish*.

*Query Name*: The name corresponding to the identifier in *Query Statement ID*. This value is transmitted as the second component of _QPD-1-Message query name_.

*Query Trigger (= MSH-9)*: The exact value that the Client will transmit in the _MSH-9-Message type_ field of the query message.

*Query Mode*: Whether the query may be sent in *Real time* (including Bolus) or in *Batch*; see section _5.5.6.3_, "_Interactive continuation of response messages_." The value *Both* indicates that both real-time/bolus and batch modes are acceptable.

*Response Trigger (= MSH-9)*: The exact value that the Server will transmit in the _MSH-9-Message type_ field of the response message.

*Query Characteristics*: Particular features of this query. This is free text intended to help the query implementor in selecting among queries.

*Purpose*: The end result that this query is intended to accomplish. Free text.

*Response Characteristics*: Particular features of this response. This is free text intended to help the query implementor in selecting among queries.

*Based on Segment Pattern*: For queries that return a segment pattern response, this is the (non-query response) message type upon which the segment pattern is based.

==== 5.3.2.3 Query grammar

The Query Profile shows a query grammar. This is a brief model of the segments used in the query message.

QBP^Znn^QBP_Qnn: Query Grammar: QBP Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ link:#RDF[RDF] ] |Table Row Definition Segment | |0
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|QBP^Znn^QBP_Qnn | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |RTB^Znn^RTB_Knn |RTB^Znn^RTB_Knn |RTB^Znn^RTB_Knn
|===

*Query Grammar*: This and the following column specify the HL7 code name and full name of each segment sent in the query. Braces specify that the segment or segment group is repeatable; brackets specify the optionality of the segment or segment group.

*Section Reference*: Specifies where in the standard further information about the segment can be found.

When the Query by Example variant is used, the Query Grammar shows the segments that may be used to transmit parameters and the order in which they appear. Segments used to transmit parameters are always sent immediately following the QPD segment.

==== 5.3.2.4 Response grammar

The Query Profile always shows a response grammar. If the query response is segment pattern, the response grammar should specify the segments, order, optionality, and repetition as do message specifications within the HL7 Standard.

RTB^Znn^RTB_Knn: Response Grammar: Widget Dispense Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|... | | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RTB^Znn^RTB_Knn | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|===

*Response Grammar*: This and the following column specify the HL7 code name and full name of each segment returned in the response. Braces specify that the segment or segment group is repeatable; brackets specify the optionality of the segment or segment group.

For Query Profiles published in the HL7 Standard, the Response Grammar table includes the Query Profile ID in parentheses in the upper left-hand cell. This allows the table to be imported automatically into the HL7 database.

*Message Description*: The full text name of the segment.

*Group Control*: The name of a segment group.

*Comment*: Specifies in English: 1) the opening or closing of a segment group, and 2) the relevance of the segment in a Hit Count. (Only positive value is noted.)

*Support Indicator*: Allows the Server to indicate: 1) whether an optional segment or segment group will be supported, or 2) that the segment or segment group is dependent on an input parameter. The default understanding is that if the Server knows the information, it will be sent.

*Sec Ref*: Specifies where in the standard further information about the segment can be found.

==== 5.3.2.5 Response grammar for display response

The response grammar for a display response lists the segment names, descriptions, and section references for the segments to be returned by the Server, as described in the previous section. In addition, the print text is displayed, as in the following example.

RDY^Znn^RDY_K15: Response Grammar: Dispense History

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[\{ link:#DSP[DSP] }] |Display Data | |5.5.1
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RDY^Znn^RDY_K15 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |- |- |-
|===

[width="100%",cols="100%",options="header",]
|===
|The data will display as follows: (Query ID=Z99)
|DSP\|\|\| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:mm-dd-yy
|DSP\|\|\| DISPENSE HISTORY REPORT PAGE n
|DSP\|\|\|MRN Patient Name MEDICATION DISPENSED DISP-DATE
|DSP\|\|\|XXXXX XXXXXx, XXXXX XXXXXXXXXXXXXXXX mm/dd/ccyy
|...
|DSP\|\|\| << END OF REPORT >>
|===

==== 5.3.2.6 QPD input parameter specification

The Input Parameter Specification section of the Query Profile looks very much like an attribute table and is followed by a commentary on the fields. Each row of the QPD Input Parameter Specification specifies one user parameter within the QPD segment. Values for user parameters are transmitted in successive fields of the QPD segment, beginning at QPD-3.

When the QSC variant is employed (see section _5.2.5.1.3_, "_Expression as a complex expression_"), a complex query expression may be used as the only input parameter, or may be combined with other (simple) input parameters.

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z99) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | | |
|===

The following is a description of the attributes of the above table.

*Field Seq*: The ordinal number of the element being discussed. Sequence 1 is [.underline]#always# Message Query Name, and sequence 2 is [.underline]#always# Query Tag. Sequence 3 and above are reserved for user parameters.

*Name*: the user-defined name for the element as will be used in the query. Example: MedicationDispensed. When *Name* is derived from an actual HL7 element (segment and field), the segment field name and element name appear in the columns headed by those names. When *Name* is not derived from an actual HL7 element (segment and field), the source system defines the values they expect in this field.

For Query Profiles published in the HL7 Standard, the Input Parameter Specification table includes the Query Profile ID in parentheses in the upper left-hand cell. This allows the table to be imported automatically into the HL7 database.

*Key/Search*: This field identifies which element is the key and which elements are searchable. The key field is designated by a value of 'K'. A value of 'S' designates fields upon which an indexed search can be performed by the source. 'L' designates non-indexed fields. (Note that searching on a non-indexed field requires the Server to perform a linear scan of the data base.) If this column is left blank, the field may not be searched.

*Sort*: valued as "Y" if the output of the query can be sorted on this field. This column should only be valued in Virtual Tables that are used as output specifications.

*Len*: the maximum field length that will be transmitted by the source.

*Type*: the data type of this user parameter. The values available for this field are described in Chapter 2, section 2.16 of this standard. Data types QIP and QSC are available for transmitting complex user parameters.

*Opt*: defines whether the field is required ('R'), optional ('O'), conditionally required ('C'), or required for backward compatibility ('B').

*Rep*: valued as 'Y' if the field may repeat (i.e., be multiply valued).

*Match Op*: the relational operator that will be applied against the value that the querying system specifies for this field.

*Note:* These are defined by file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70209[_HL7 Table 0209 – Relatio__nal Operator_], a component of the QSC data type

*TBL*: identifies the HL7 table from which the values are derived.

*Segment Field Name*: identifies the HL7 segment and field from which the new definition is derived. This field will be blank if the Name is NOT derived from an actual HL7 segment and field.

*Service Identifier Code:* a value of data type CWE that contains the applicable LOINC code, if it exists, or the applicable HL7 code, if it exists, if no Segment Field Name has been identified. If a Segment Field Name has been identified, this field is not populated.

*Element Name*: the name of the element identified by Segment Field Name. This may also be a user-defined 'Z'-element.

==== 5.3.2.7 QPD input parameter field description and commentary

The QPD Input Parameter Field Description and Commentary provides a more detailed description of each of the fields transmitted in the QPD segment.

[width="100%",cols="21%,11%,6%,62%",options="header",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z99^WhoAmI^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|InputItem... | |CX |
|===

*Input Parameter*: The name of the field whose value is being transmitted.

*Comp. Name*: When the *Input Parameter* is of a composite data type (e.g._,_ XPN), this is the name of an individual component of the composite input parameter. Only those components that may be valued should be listed in this column.

*DT*: The data type of the parameter or component.

*Description*: A narrative description of the parameter or component and how it is to be used.

==== 5.3.2.8 QBE input parameter specification

In the Query by Example variant, discussed below in section _5.9.7_, "_ +
Query by example (QBP) / tabular response (RTB_)," the Query Profile may specify that the client may use fields within actual message segments, such as the PID segment, to transmit parameter information. Where this is permitted, the Query Profile includes a "QBE Input Parameter Specification" table to specify which fields may be used to transmit the parameters.

*QBE Input Parameter Specification*

[width="99%",cols="13%,14%,9%,3%,6%,7%,5%,5%,8%,6%,12%,12%",options="header",]
|===
|Segment Field Name (Query ID=Z99) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

Fields are indicated by their actual Segment Field Name, which specifies both segment and position. Except for this distinguishing feature, the remaining columns in this table are identical in meaning to their counterparts in the "_QPD input parameter specification_" in section _5.3.2.6_ above.

Each row of the QBE Input Parameter Specification specifies one field that may be used to transmit user parameters within the example segment(s).

==== 5.3.2.9 QBE input parameter field description and commentary

The QPD Input Parameter Field Description and Commentary provides a more detailed description of each of the fields transmitted in the example segments sent in a Query by Example.

*QBE Input Parameter Field Description and Commentary*

[width="100%",cols="17%,11%,8%,64%",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

Fields are indicated by their actual Segment Field Name, which specifies both segment and position. Except for this distinguishing feature, the remaining columns in this table are identical in meaning to their counterparts in the "_QPD input parameter field description and commentary_" in section _5.3.2.7_ above.

==== 5.3.2.10 RCP input parameter field description and commentary

The RCP Input Parameter Field Description and Commentary provides a more detailed description of each of the fields transmitted in the RCP (Response Control Parameters) segment.

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="19%,22%,11%,5%,5%,38%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name |Com­po­nent Name |LEN |DT |Description
| | | | | |
|===

*Field Seq*: The position within the RCP segment that the field occupies.

*Name*: The name of the field whose value is being transmitted.

*Component Name*: When the field referenced by *Name* is of a composite data type (e.g., XPN), this is the name of an individual component of the composite input parameter. Only those components that may be valued should be listed in this column.

*LEN*: The maximum length of the field.

*DT*: The data type of the parameter or component.

*Description*: A narrative description of the parameter or component and how it is to be used.

==== 5.3.2.11 Input specification: virtual table

When the QSC variant is in use, the Query Profile includes a Virtual Table specification listing the fields that the Client may include in the complex expression parameter.

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Znn) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

The *ColName* column identifies each field name that the Client may include in the complex query expression. Other columns in this table are defined as in section _5.3.2.6_ above.

When both the QSC variant and a tabular response are specified, this table is labeled "Input/Output Specification: Virtual Table" and no separate output specification is provided.

==== 5.3.2.12 Virtual table field description and commentary

The Virtual Table Field Description and Commentary provides a more detailed description of each of the fields listed in the Virtual Table.

*Virtual Table Field Description and Commentary*

[width="100%",cols="19%,11%,6%,64%",options="header",]
|===
|ColName (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

*ColName*: The name used to identify the column, or field, in the complex expression.

*Comp. Name*: When the *ColName* is of a composite data type (e.g., XPN), this is the name of an individual component of the column. Only those components that may be valued should be listed.

When specifying a field in the complex expression, both the *ColName* and *Comp. Name* attributes should be sent if only a single component is being identified. For instance, *PatientList.ID* would specify the ID component of the *PatientList* field.

*DT*: The data type of the field or component.

*Description*: A narrative description of the field or component and how it is to be used.

==== 5.3.2.13 Output specification for tabular response

The output specification for the tabular response consists of the Virtual Table description, i.e., the columns and rows. It has the same columns as the input specification, but the rows reflect all of the available rows in the table, not just those that can be filtered upon input.

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z99) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

The usage of the columns in this table is as described in section _5.3.2.8_, "_QBE input parameter specification_." Note that the Key/Search and Match Op fields are only meaningful when a virtual table is used in the input specification (QSC variant).

When the QSC variant is in use, the "Input/Output Specification and Commentary" virtual table is used for selection of output fields. No separate table is specified for output.

=== 5.3.3 Query Profile templates

==== 5.3.3.0 hiddentext

==== 5.3.3.1 Query Profile template for query with tabular response

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Znn): |
|Type: |
|Query Name: |
|Query Trigger (= MSH-9): |
|Query Mode: |
|Response Trigger (= MSH-9): |
|Query Characteristics: |
|Purpose: |
|Response Characteristics: |
|Based on Segment Pattern: |
|===

The message structure for QBP^Znn^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Znn^RTB_K13: Response Grammar: RTB Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ ERR ] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.4.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.6.6
|[ \{ link:#RDT[RDT] } ] |Table Row Data Segment | |5.5.6
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RTB^Znn^RTB_K13 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |- |- |-
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|*3* |*InputItem . . .* | | | | | | | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,12%,9%,59%",options="header",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
|*MessageQueryName* | |CWE |SHALL be valued *Znn^<query name>^HL7nnnn*.
|*QueryTag* | |ST |Unique to each query message instance.
|*InputItem1* | |DataType |
| | | |Components: (if applicable)
| | | |(Description)
| | | |(Valuation note)
| | | |
| |*Component1* (if applicable) |DataType |(Valuation note)
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Znn) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

*Virtual Table Field Description and Commentary*

[width="100%",cols="19%,11%,6%,64%",options="header",]
|===
|ColName (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

{empty}[The following table is used only for the Query by Example variant.]

*QBE Input Parameter Specification*

[width="100%",cols="19%,18%,8%,6%,6%,7%,3%,3%,7%,5%,9%,9%",]
|===
|Segment Field Name (Query ID=Znn) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Query by Example (QBE) variant.]

*QBE Input Parameter Field Description and Commentary*

[width="100%",cols="17%,11%,8%,64%",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="18%,23%,11%,5%,5%,38%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name |Com­po­nent Name |LEN |DT |Description
| | | | | |
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Znn) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

==== 5.3.3.2 Query Profile template for query with segment pattern response

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Znn): |
|Type: |
|Query Name: |
|Query Trigger (= MSH-9): |
|Query Mode: |
|Response Trigger (= MSH-9): |
|Query Characteristics: |
|Purpose: |
|Response Characteristics: |
|Based on Segment Pattern: |
|===

QBP^Znn^QBP_Q11: Query Grammar: QBP Message

[width="99%",cols="3%,31%,,47%,,9%,,10%",options="header",]
|===
|Segments | |Description | |Status | |Sec. Ref |
|MSH | |Message Header Segment | | | |2.15.9 |
|[\{ARV}] | |Access Restriction | | | |3 |
|[\{SFT}] | |Software Segment | | | |2.15.12 |
|[ UAC ] | |User Authentication Credential | | | |2.14.13 |
|link:#QPD[QPD] | |Query Parameter Definition | | | |5.5.4 |
|[ | |--- QBP begin | | | | |
|[...] | |Optional query by example segments | | | | |
|] | |--- QBP end | | | | |
|link:#RCP[RCP] | |Response Control Parameter | | | |5.5.6 |
|[ DSC ] | |Continuation Pointer | | | |2.15.4 |
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|QBP^Znn^QBP_Q11 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |RSP^Znn^RSP_Znn |RSP^Znn^RSP_Znn |RSP^Znn^RSP_Znn
|===

RSP^Znn^RSP_Znn: Response Grammar: RSP Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[...] |(additional segments according to the data to be produced) | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RSP^Znn^RSP_Znn | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |- |- |-
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Znn) |Col Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |InputItem . . . | | | | | | | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="19%,12%,9%,60%",options="header",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Znn^<query name>^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|*InputItem1* | |DataType |
| | | |Components: (if applicable)
| | | |(Description)
| | | |(Valuation note)
| | | |
| |*Component1* (if applicable) |DataType |(Valuation note)
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Znn) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

*Virtual Table Field Description and Commentary*

[width="100%",cols="19%,11%,6%,64%",options="header",]
|===
|ColName (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

{empty}[The following table is used only for the Query by Example (QBE) variant.]

*QBE Input Parameter Specification*

[width="100%",cols="19%,18%,8%,6%,6%,7%,3%,3%,7%,5%,9%,9%",]
|===
|Segment Field Name (Query ID=Znn) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Query by Example variant.]

*QBE Input Parameter Field Description and Commentary*

[width="100%",cols="17%,11%,8%,64%",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,28%,11%,5%,5%,38%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name |Com­po­nent Name |LEN |DT |Description
| | | | | |
|===

==== 5.3.3.3 Query Profile for query with display response

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Znn): |
|Type: |
|Query Name: |
|Query Trigger (= MSH-9): |
|Query Mode: |
|Response Trigger (= MSH-9): |
|Query Characteristics: |
|Purpose: |
|Response Characteristics: |
|Based on Segment Pattern: |
|===

The message structure for QBP^Znn^QPB_Q15 can be found in 5.4.3. Use the QBP^Q15^QPB_Q15 Message structure.

RDY^Znn^RDY_K15: Response Grammar: RDY Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|MSA |Message Acknowledgement | |2.15.8
|[ ERR ] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[\{ link:#DSP[DSP] }] |Display Data | |5.5.1
|[ DSC ] |Continuation Pointer | |2.15.4
|[ UAC ] |User Authentication Credential | |2.14.13
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RDY^Znn^RDY_K15 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Znn^ACK
|Application Ack |- |- |-
|===

[width="100%",cols="100%",options="header",]
|===
|The data will display as follows: (Query ID=Znn)
|DSP\|\|\| (data in actual display format)
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
| |*InputItem* | | | | | | | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="19%,12%,9%,60%",options="header",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Znn^<query name>^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|*InputItem1* | |DataType |
| | | |Components: (if applicable)
| | | |(Description)
| | | |(Valuation note)
| | | |
| |*Component1* (if applicable) |DataType |(Valuation note)
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Znn) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Complex Expression (QSC) variant.]

[width="100%",cols="19%,11%,6%,64%",options="header",]
|===
|ColName (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

{empty}[The following table is used only for the Query by Example (QBE) variant.]

*QBE Input Parameter Specification*

[width="100%",cols="19%,18%,8%,6%,6%,7%,3%,3%,7%,5%,9%,9%",]
|===
|Segment Field Name (Query ID=Znn) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Service Identifier Code |Element Name
| | | | | | | | | | | |
|===

{empty}[The following table is used only for the Query by Example variant.]

*QBE Input Parameter Field Description and Commentary*

[width="100%",cols="17%,11%,8%,64%",]
|===
|Input Parameter (Query ID=Znn) |Comp. Name |DT |Description
| | | |
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,28%,11%,5%,5%,38%",options="header",]
|===
|Field Seq (Query ID=Znn) |Name |Com­po­nent Name |LEN |DT |Description
| | | | | |
|===

==== 5.3.3.4 Query Profile table summaries

The following table lists the tables that are to be included in each Query Profile. The differences arise both from the query variant used and the response type provided.

[width="100%",cols="17%,14%,49%,20%",]
|===
|Response Type |Query Variant |Table Included |Section Reference
|Display |None (QPD) |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar for display response |5.3.2.5
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |RCP input parameter field description and commentary |5.3.2.10
|Display |QBE |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar for display response |5.3.2.5
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |QBE input parameter specification |5.3.2.8
| | |QBE input parameter field description and commentary |5.3.2.9
| | |RCP input parameter field description and commentary |5.3.2.10
|Display |QSC |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar for display response |5.3.2.5
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |Input specification: virtual table |5.3.2.11
| | |Virtual table field description and commentary |5.3.2.12
|Tabular |None (QPD) |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |RCP input parameter field description and commentary |5.3.2.10
| | |Output specification for tabular response |5.3.2.13
|Tabular |QBE |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |QBE input parameter specification |5.3.2.8
| | |QBE input parameter field description and commentary |5.3.2.9
| | |RCP input parameter field description and commentary |5.3.2.10
| | |Output specification for tabular response |5.3.2.13
|Tabular |QSC |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |Input/output specification: virtual table |5.3.2.11
| | |Virtual table field description and commentary |5.3.2.12
| | |RCP input parameter field description and commentary |5.3.2.10
|Segment pattern |None (QPD) |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |RCP input parameter field description and commentary |5.3.2.10
|Segment pattern |QBE |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |QBE input parameter specification |5.3.2.8
| | |QBE input parameter field description and commentary |5.3.2.9
| | |RCP input parameter field description and commentary |5.3.2.10
|Segment pattern |QSC |Query Profile introduction |5.3.2.2
| | |Query grammar |5.3.2.3
| | |Response grammar |5.3.2.4
| | |QPD input parameter specification |5.3.2.6
| | |QPD input parameter field description and commentary |5.3.2.7
| | |Input specification: virtual table |5.3.2.11
| | |Virtual table field description and commentary |5.3.2.12
| | |RCP input parameter field description and commentary |5.3.2.10
|===

== 5.4 QUERY/RESPONSE MESSAGE PAIRS

The query recommended for use in v 2.4 and later is the Query by Parameter (QBP). The query/response message pairs that follow in this section supersede the previous generation of original mode and enhanced queries that are described in sections _5.10.2_, "_Original mode queries_," and, in v 2.6 and preceding, 5.10.3, "Originally Mode Deferred Access," and 5.10.4, "Other Query/Response Message Segments."

All queries SHALL have a Query Name. The Query Name field, which is a CWE data type, uniquely identifies a Query Profile.

The QBP allows for several variants in defining the selection criteria.

The first variant, the Query by (Simple) Parameter, is to declare a sequence of one to many HL7 fields. Each of these fields will retain its data type as defined in the original HL7 usage. Each field corresponds to a parameter in the Query Profile.

*Note:* It is the responsibility of the Server to declare explicitly the purpose of the query, the meaning of each of the query parameters, and the relationships among the parameters. These declarations are made in the Query Profile.

A second variant, the Query by Example, allows the specification of parameters within actual HL7 segments other than the QPD. For example, the Query Profile might permit the use of the PID segment to transmit specific patient identification parameters. Each such parameter is specified in *the QBE Input Parameter Specification* and *QBE Input Parameter Field Description and Commentary* tables.

The third variant uses a single QPD parameter in the form of a complex query selection expression. This field with its QSC data type allows the defining segment to be broader in scope and allows any field in the target data to be selected and filtered unless constrained through the Query Profile. It explicitly states any relational operators such as AND and OR. It is intended to support a wide range of combinations of parameters.

The difference in how parameters are passed in each of these three variants is as follows:

Query by Simple Parameter passes each client value to the Server positionally using only the third and successive fields of the QPD segment.

Query by Example passes parameters using HL7 segments, such as PID, that are defined in the endpoint application chapters. The third and successive fields of the QPD segment also may be used in this variant.

In the QSC Selection Criteria variant, the parameter values are all contained within a single complex query selection expression that is passed in QPD-3.

Each generic query has a specific message syntax, a unique trigger event, and a unique message structure. Each generic response also has a specific message syntax, a unique trigger event, and a unique message structure.

There are three generic message structures, each of which accommodates the specific detail needed in each of the three response types.

The QBP_Q11 structure supports a Segment Pattern Response and contains the MSH, QPD, RCP, and DSC segments. Its default trigger event is Q11. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with Z.

The QBP_Q13 structure supports a Tabular Response and contains the MSH, RCP, RDF, and DSC segments. Its default trigger event is Q13. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with Z.

The QBP_Q15 structure supports a Display Response and contains the MSH, QPD, RCP, and DSC segments. Its default trigger event is Q15. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with Z.

The new queries support both immediate and deferred response. This information is carried in the RCP segment along with the execution date and time.

The query definition segment is echoed back in the response. This is particularly important in a continuation situation. Otherwise, the sender might conceivably have to manage a queue of queries.

=== 5.4.1 QBP/RSP – query by parameter/segment pattern response (events vary)

QBP^Q11^QBP_Q11: Query By Parameter

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{ARV}] |Access Restriction | |3
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition Segment | |5.5.4
|[ |--- QBP begin | |
|[...] |Optional query by example segments | |
|] |--- QBP end | |
|link:#RCP[RCP] |Response Control Parameters | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|QBP^Q11^QBP_Q11 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q11^ACK
|Application Ack |RSP^K11^RSP_K11 |RSP^K11^RSP_K11 |RSP^K11^RSP_K11
|===

The QBP_Q11 structure supports a Segment Pattern Response and contains the MSH, QPD, RCP, and DSC segments. Its default trigger event is Q11. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with *Z*.

RSP^K11^RSP_K11: Segment Pattern Response

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.3
|MSA |Message Acknowledgement | |2.15.8
|[\{ ERR }] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.4.2
|link:#QPD[QPD] |Query Parameter Definition Segment | |5.5.4
|[ |--- SEGMENT_PATTERN begin | |
|... |Segment Pattern from Query Profile | |
|] |--- SEGMENT_PATTERN end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RSP^K11^RSP_K11 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^K11^ACK
|Application Ack |- |- |-
|===

The RSP_K11 supports a Segment Pattern Response to the QBP and contains the MSH, MSA, ERR, QAK, QPD, variable content segments, and the DSC. Its default trigger event is K11. A standard or site-defined response may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined response, that value SHALL begin with *Z*.

*Note on QBP*: Query By Example variant: The query by example is an extension of Query by Parameter (QBP) in which search parameters are passed by sending them in the segment which naturally carries them. A Query Profile which uses this variant SHALL replace the ellipses in the input QBP_Q11 grammar above, with the specific segments that it accepts.

*Note*: The indicated trigger events are the default values for MSH-9-2-Trigger event. Standard and site-defined queries may use these trigger events or may specify unique trigger event values in their Query Profiles. Unique trigger event values for site-defined queries SHALL begin with *Z*.

*Note on RSP:* The Query Profile for each QBP/RSP pair shall specify an explicit segment pattern grammar in place of the ellipses shown above in the RSP_K11 grammar.

=== 5.4.2 QBP/RTB – query by parameter/tabular response (events vary)

The QBP_Q13 structure supports a Tabular Response and contains the MSH, RDF, RCP, and DSC segments. Its default trigger event is Q13. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with *Z*.

Unless otherwise specified in the query's Query Profile, the default value for the RDF segment shall be understood to contain all available fields from the Virtual Table. The Client may override the default RDF by specifying explicitly the columns to be returned.

The message structure for QBP^Q13^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^K13^RTB_K13: Table Based Response

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[\{ ERR }] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.4.2
|link:#QPD[QPD] |Query Definition Segment | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.5.6
|[ \{ link:#RDT[RDT] } ] |Table Row Data Segment | |5.5.6
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RTB^K13^RTB_K13 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^K13^ACK
|Application Ack |- |- |-
|===

The RTB_K13 supports a Tabular Response to the QBP and contains the MSH, MSA, ERR, QAK, QPD, RDF, RDT and the DSC. Its default trigger event is K13. A standard or site-defined response may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined response, that value SHALL begin with *Z*.

The RTB_K13 structure requires that, if any RDT segments are returned, they be preceded by an RDF segment containing the row definition specification for the RDT segments. If no RDF was sent in the query, the default RDF is returned in the RTB_K13.

*Note:* The indicated trigger events are the default values for MSH-9-2-Trigger event. Standard and site-defined queries may use these trigger events or may specify unique trigger event values in their Query Profiles. Unique trigger event values for site-defined queries SHALL begin with *Z*.

=== 5.4.3 QBP/RDY – query by parameter/display response (events vary)

QBP^Q15^QBP_Q15: Query By Parameter

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition Segment | |5.5.4
|[...] |Optional query by example segments | |
|link:#RCP[RCP] |Response Control Parameters | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.14
|===

[width="100%",cols="20%,30%,25%,25%",options="header",]
|===
|Acknowledgement Choreography | | |
|QBP^Q15^QBP_Q15 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q15^ACK
|Application Ack |RDY^K15^RDY_K15 |RDY^K15^RDY_K15 |RDY^K15^RDY_K15
|===

The QBP_Q15 structure supports a Display Response and contains the MSH, QPD, RCP, and DSC segments. Its default trigger event is Q15. A standard or site-defined query may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined query, that value SHALL begin with *Z*.

RDY^K15^RDY_K15: Display Based Response

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[\{ ERR }] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.4.2
|link:#QPD[QPD] |Query Parameter Definition Segment | |5.5.4
|[ \{ link:#DSP[DSP] } ] |Display Data | |5.5.1
|[ DSC ] |Continuation Pointer | |2.15.14
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|RDY^K15^RDY_K15 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^K15^ACK
|Application Ack |- |- |-
|===

The RDY_K15 supports a Display Response to the QBP and contains the MSH, MSA, ERR, QAK, DSP, and the DSC. Its default trigger event is K15. A standard or site-defined response may use this trigger event or may specify a unique trigger event value in its Query Profile. If a unique trigger event value is chosen for a site-defined response, that value SHALL begin with *Z*.

*Note:* The indicated trigger events are the default values for MSH-9-2-Trigger event. Standard and site-defined queries may use these trigger events or may specify unique trigger event values in their Query Profiles. Unique trigger event values for site-defined queries SHALL begin with *Z*.

*Note on QBP*: Query By Example variant: The query by example is an extension of Query by Parameter (QBP) in which search parameters are passed by sending them in the segment which naturally carries them. A Query Profile which uses this variant SHALL replace the ellipses in the input QBP_Q11 grammar above, with the specific segments that it accepts.

=== 5.4.4 QSB – Create subscription (Event Q16)

See section _5.7_, "_PUBLISH AND SUBSCRIBE_" for more information about this event.

QSB^Q16^QSB_Q16: Create Subscription

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|link:#RCP[RCP] |Response Control Parameters | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="20%,30%,25%,25%",options="header",]
|===
|Acknowledgement Choreography | | |
|QSB^Q16^QSB_Q16 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q16^ACK
|Application Ack |ACK^Q16^ACK |ACK^Q16^ACK |ACK^Q16^ACK
|===

ACK^Q16^ACK: General Acknowledgment

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgment | |2.15.8
|[ ERR ] |Error | |2.15.5
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|ACK^Q16^ACK | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q16^ACK
|Application Ack |- |- |-
|===

=== 5.4.5 QVR – query for previous events (Event Q17)

The Query for Previous Events is like a Query by Parameter with a Segment Pattern Response except that the response consists of zero to many messages of the type defined in the Query Profile rather than a single response message containing multiple iterations of the segment pattern. While the messages sent in response to a QVR will reflect events which occurred in the past, the time stamp in the message header will reflect the time the message is actually constructed (current time). It is also similar to the previous generation VQQ/RQQ Event Replay.

While the response is similar to subscription messages, it differs from subscription in that the response messages are the result of "interrogating" the database rather than events being triggered in the current timeframe.

In a Query for Previous Events, the Server still has to parse the query, but avoids the handshaking protocols required in normal query/response situations. The Server acknowledges the query with the general acknowledgement message ACK. The Server then transmits a sequence of messages as if they were simulated unsolicited messages. This is useful for low end systems that unable to deal with the overhead of the query response message syntax, i.e., systems that can only process unsolicited update messages.

Systems that choose to offer the QVR should offer guidance in the Query Profile, where appropriate, concerning the scope and size of the data requested by the Client. Moreover, the Query Profile should contain language cautioning Clients of the potential for harm from getting messages out of the original sequence and/or context.

Use cases for this query are as follows: 1) to populate a database initially, 2) to recover from an extended down time on the part of the recipient, or 3) to enable systems which normally receive unsolicited data to be extended to act as a query client with minimal modification.

*Note:* If there is a concern that it will be difficult to distinguish these messages from any current realtime messages, e.g., if they are going down the same pipe, the data offerer might choose to designate a unique _MSH-3 Sending application_ for the messages it sends in response to a QVR. This would allow downstream systems to recognize which messages were the result of the QVR, versus which are the result of current realtime activity on the sending system. For example, there may be 2 systems receiving pharmacy dispense messages. If system A wishes to issue a QVR to receive a historical load, system B might misinterpret the QVR results coming over the pipe as actual live data. A separate Sending Application name would allow for easy differentiation.

QVR^Q17^QVR_Q17: Query for Previous Events

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Event Definition Segment | |5.5.4
|[ |--- QBP begin | |
|[...] |Optional query by example segments | |
|] |--- QBP end | |
|link:#RCP[RCP] |Response Control Parameters | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="20%,30%,25%,25%",options="header",]
|===
|Acknowledgement Choreography | | |
|QVR^Q17^QVR_Q17 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q17^ACK
|Application Ack |ACK^Q17^ACK |ACK^Q17^ACK |ACK^Q17^ACK
|===

ACK^Q17^ACK: General Acknowledgment

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgment | |2.15.8
|[ ERR ] |Error | |2.15.5
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|ACK^Q17^ACK | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^Q17^ACK
|Application Ack |- |- |-
|===

The QVR message segments are identical to those of the QBP. A QVR Query Profile may use either the QSC or query by example syntactic variants as well as the query by simple parameter.

=== 5.4.6 QCN/ACK – cancel query/acknowledge message (Event J01)

QCN^J01^QCN_J01: Cancel Query

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QID[QID] |Query identification Segment | |5.5.3
|===

[width="100%",cols="20%,30%,25%,25%",options="header",]
|===
|Acknowledgement Choreography | | |
|QCN^J01^QCN_J01 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^J01^ACK
|Application Ack |ACK^J01^ACK |ACK^J01^ACK |ACK^J01^ACK
|===

ACK^J01^ACK: General Acknowledgment

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgment | |2.15.8
|[ ERR ] |Error | |2.15.5
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|ACK^J01^ACK | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^J01^ACK
|Application Ack |- |- |-
|===

=== 5.4.7 QSX /ACK – cancel subscription/acknowledge message (Event J02)

See section _5.6_, "_AUXILIARY QUERY PROTOCOLS_" for more information about this event.

QSX^J02^QCN_J01: Cancel Subscription

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QID[QID] |Query identification Segment | |5.5.3
|===

[width="100%",cols="21%,31%,24%,24%",options="header",]
|===
|Acknowledgement Choreography | | |
|QSX^J02^QCN_J01 | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |AL |AL
|Immediate Ack |- |- |ACK^J02^ACK
|Application Ack |ACK^J02^ACK |ACK^J02^ACK |ACK^J02^ACK
|===

ACK^J02^ACK: General Acknowledgment

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgment | |2.15.8
|[ ERR ] |Error | |2.15.5
|===

[width="100%",cols="24%,37%,10%,29%",options="header",]
|===
|Acknowledgement Choreography | | |
|ACK^J02^ACK | | |
|Field name |Field Value: Original mode |Field value: Enhanced mode |
|MSH-15 |Blank |NE |AL, SU, ER
|MSH-16 |Blank |NE |NE
|Immediate Ack |- |- |ACK^J02^ACK
|Application Ack |- |- |-
|===

== 5.5 QUERY/RESPONSE MESSAGE SEGMENTS

This section includes all message segments, except for the general message segments, used for the query/response pairs recommended for use in v 2.4 and later.

=== 5.5.1 DSP – Display Data segment

The DSP segment is used to contain data that has been preformatted by the sender for display. The semantic content of the data is lost; the data is simply treated as lines of text.

HL7 Attribute Table – DSP[#DSP .anchor]#### – Display Data

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM # |ELEMENT NAME
|1 |1..4 | |SI |O | | |00061 |Set ID – DSP
|2 |1..4 | |SI |O | | |00062 |Display Level
|3 | |300 |TX |R | | |00063 |Data Line
|4 | |2 |ST |O | | |00064 |Logical Break Point
|5 | |20 |TX |O | | |00065 |Result ID
|===

==== 5.5.1.0 DSP field definitions

==== 5.5.1.1 DSP-1 Set ID – DSP (SI) 00061 

Definition: This field is used optionally to number multiple display segments.

==== 5.5.1.2 DSP-2 Display Level (SI) 00062 

Definition: This field contains numbering to define groups of fields as assigned by the individual sites or applications.

==== 5.5.1.3 DSP-3 Data Line (TX) 00063 

Definition: This field contains an actual line as it should be displayed. As described for the TX data type, highlighting and other special display characteristics may be included.

==== 5.5.1.4 DSP-4 Logical Break Point (ST) 00064 

Definition: This field is non‑null if this line is the last line of a logical break point in the response as defined by the responding system.

Often the lines of display text will fall into logical groups that differ from the physical size of a screen or printer page. For example, a complete battery or an entire radiology report might be thought of as comprising a logical group, though it might have as few as six or as many as 120 lines. Knowledge of the logical break points in the display data can be useful to the application system that is displaying or printing data. For this reason, _DSP-4-Logical break point_ is used. The sending application (the one that formats the data) places the logical break points where appropriate. If there is a particular ancillary result ID associated with the data delineated by _DSP-4-Logical break point_, the value of this ID also can be returned in _DSP-5-Result ID_. Then if the user selects the area of the display delineated by _DSP-4-Logical break point_, the displaying system can query for the associated _DSP-5-Result ID_.

==== 5.5.1.5 DSP-5 Result ID (TX) 00065 

Definition: When the user selects a result ID (defined by _DSP-4-Logical break point_) from the screen display corresponding to a record in which _DSP-5-Result ID_ is non-null, the application can initiate a second query (a separate session) to the ancillary with the _QRD-10-What department data code_ filled in with this non-null value (e.g., the ancillary accession number or its equivalent). The ancillary response will contain the report referenced by this result ID (e.g., accession number). The ancillary should correlate the result ID with _DSP-4-Logical break point_ as follows: If more than one line of text is sent per result, _DSP-5-Result ID_ should be only non-null for a DSP segment that contains a non-null _DSP-4-Logical break point_. This field may be broken into components by local agreement. A common example might be to include placer order number, filler order number, and universal service identifier. Whenever such fields are used as components of the result ID, their components will be sent as subcomponents.

=== 5.5.2 QAK - Query Acknowledgment segment

The QAK segment contains information sent with responses to a query. The QAK segment may appear as an optional segment placed after the (optional) ERR segment in any query response (message) to any original mode query.

HL7 Attribute Table – QAK[#QAK .anchor]#### – Query Acknowledgment

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 | |32= |ST |C | | |00696 |Query Tag
|2 |2..2 | |ID |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70208[0208] |00708 |Query Response Status
|3 | | |CWE |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[0471] |01375 |Message Query Name
|4 | |10= |NM |O | | |01434 |Hit Count Total
|5 | |10= |NM |O | | |01622 |This payload
|6 | |10= |NM |O | | |01623 |Hits remaining
|===

==== 5.5.2.0 QAK field definitions

==== 5.5.2.1 QAK-1 Query Tag (ST) 00696 

Definition: This field may be valued by the initiating system to identify the query, and may be used to match response messages to the originating query. If it is valued, the responding system is required to echo it back as the first field in the query acknowledgment segment (QAK). This field differs from _MSA-2-message control ID_ in that its value remains constant for each message (i.e., all continuation messages) associated with the query, whereas _MSA-2-Message control ID_ may vary with each continuation message, since it is associated with each individual message, not the query as a whole. _QAK-1-Query tag_ is not conditional on the presence of the _QRD-1-Query ID_ field in the original mode queries; in the original mode queries _QAK-1-Query tag_ is not used.

==== 5.5.2.2 QAK-2 Query Response Status (ID) 00708 

Definition: This field allows the responding system to return a precise response status. It is especially useful in the case where no data is found that matches the query parameters, but where there is also no error. Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70208[_HL7 Table 0208 – Query Response Status_] in Chapter 2C, Code Tables, for valid values.

==== 5.5.2.3 QAK-3 Message Query Name (CWE) 01375 

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains the name of the query. These names are assigned by the function-specific chapters of this specification. Site-specific event replay query names begin with the letter "Z." Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[_User defined table 0471 – Query name_] in Chapter 2C, Code Tables, for suggested values.

==== 5.5.2.4 QAK-4 Hit Count Total (NM) 01434

Definition: This field, when used, contains the total number of records found by the Server that matched the query. For tabular responses, this is the number of rows found. For other response types, the Query Profile defines the meaning of a "hit."

==== 5.5.2.5 QAK-5 This Payload (NM) 01622

Definition: This field, when used, contains the total number of matching records that the Server sent in the current response. Where the continuation protocol is used to transmit the response in partial installments, this number will differ from the value sent in _QAK-4-Hit count total_.

==== 5.5.2.6 QAK-6 Hits Remaining (NM) 01623

Definition: This field, when used, contains the number of matching records found by the Server that have yet to be sent. It is only meaningful when the Server uses the continuation protocol to transmit partial responses.

=== 5.5.3 QID - Query Identification segment

The QID segment contains the information necessary to uniquely identify a query. Its primary use is in query cancellation or subscription cancellation.

HL7 Attribute Table – QID[#QID .anchor]#### – Query Identification

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 | |32= |ST |R | | |00696 |Query Tag
|2 | | |CWE |R | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[0471] |01375 |Message Query Name
|===

==== 5.5.3.0 QID field definitions

==== 5.5.3.1 QID-1 Query Tag (ST) 00696

Definition: This field identifies the instance of a query.

==== 5.5.3.2 QID-2 Message Query Name (CWE) 01375

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains the name of the query. These names are assigned by the function-specific chapters of this specification. Site-specific query names begin with the letter "Z." Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[_User defi__ned table 0471 – Query name_] for suggested values.

=== 5.5.4 QPD – Query Parameter Definition segment

The QPD segment defines the parameters of the query.

HL7 Attribute Table – QPD[#QPD .anchor]#### – Query Parameter Definition

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 | | |CWE |R | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[0471] |01375 |Message Query Name
|2 | |32= |ST |C | | |00696 |Query Tag
|3-n | |256= |varies |O | | |01435 |User Parameters (in successive fields)
|===

==== 5.5.4.0 QPD field definitions

==== 5.5.4.1 QPD-1 Message Query Name (CWE) 01375 

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains the name of the query. These names are assigned by the function-specific chapters of this specification. It is one to one with the Query Profile for this query name, and it is in fact an identifier for that Query Profile. Site-specific query names begin with the letter "Z." Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70471[_User defined table 0471 – Q__uery name_] in Chapter 2C, Code Tables, for suggested values.

==== 5.5.4.2 QPD-2 Query Tag (ST) 00696 

Definition: This field may be valued by the initiating system to identify the query, and may be used to match response messages to the originating query. If this field is valued, the responding system is required to echo it back as the first field in the query acknowledgement segment (QAK).

This field differs from _MSA-2-Message control ID_ in that its value remains constant for each message (i.e., all continuation messages) associated with the query, whereas _MSA-2-Message control ID_ may vary with each continuation message, since it is associated with each individual message, not the query as a whole.

*_Implementation considerations:_* It is not necessary to value this field in implementations where the only return message on the socket will be the response to the query that was just sent. Conversely, in an "asynchronous" implementation where many queries, responses, and other messages may be communicated bidirectionally over the same socket, it is essential that this field be valued so that the Client knows to which query the Server is responding.

==== 5.5.4.3 QPD-3 User Parameters (Varies) 01435 

Definition: These successive parameter fields hold the values that the Client passes to the Server.

The client data is presented as a sequence of HL7 fields. Beginning at _QPD-3-User parameters_, the remaining fields of the QPD segment carry user parameter data. Each QPD user parameter field corresponds to one parameter defined in the Query Profile, where each name, type, optionality, and repetition of each parameter has been specified. While these parameters are understood to be usually "anded" together, the user SHALL inspect the required Query Profile to properly understand each. Except in the QSC variant, the parameter names do not need to be stated in the query; they are understood to be positional based on the Query Profile.

Each parameter field may be specified in the Query Profile to be of any single data type, including the complex QIP and QSC types. Parameter fields may also contain the sort control (SRT) field or the segment group (ID) field defined in Sections _5.5.6.6_, "_RCP-6 Sort-by Field (SRT)_ 01624," and _5.5.6.7_, "_RCP-7 Segment Group Inclusion (ID)_ 01594," below.

Parameter fields in the QPD segment appear in the same order as in the Query Profile.

===== 5.5.4.3.1 Note on QPD usage for query by example variant.

*Note:* Query By Example: The Query by Example is an extension of Query by Parameter (QBP) in which search parameters are passed by sending them in the segment which naturally carries them. Thus if one wanted to perform a "find_candidates" query using query by example, one would send the demographics information on which to search in the PID and/or PD1 segments leaving blank those fields in the segment sent which are not query parameters. If, for example, religion were not one of the query parameters, PID-17 would be left blank when the PID was sent in the query. Parameters which do not occur naturally in an HL7 message, such as search algorithm, confidence level, etc, would continue to be carried in the QPD segment as they are in the Query by Parameter. The segments and fields available for use as query parameters would be specified in the Query Profile for the query.

=== 5.5.5 QRI – Query Response Instance segment 

The QRI segment is used to indicate the weight match for a returned record (where the responding system employs a numeric algorithm) and/or the match reason code (where the responding system uses rules or other match options).

Examples of the use of this segment appear in Chapter 3, "Patient Administration," section 3.3.57, "Find Candidates and Response."

HL7 Attribute Table – QRI – Query Response Instance

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 | |10# |NM |O | | |01436 |Candidate Confidence
|2 |2..2 | |CWE |O |Y |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70392[0392] |01437 |Match Reason Code
|3 | | |CWE |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70393[0393] |01438 |Algorithm Descriptor
|===

==== 5.5.5.0 QRI field definitions

==== 5.5.5.1 QRI-1 Candidate Confidence (NM) 01436 

Definition: This field contains a numeric value indicating the match weight or confidence level associated with the record.

Example: |0.88| or |12.32|

One use of this optional field is in Patient Look-up transactions where the searching system employs a numeric algorithm for determining potential matches to patient/person look-ups.

==== 5.5.5.2 QRI-2 Match Reason Code (CWE) 01437 

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains a coded value indicating what search components (e.g., name, birth date, social security number) of the record returned matched the original query where the responding system does not assign numeric match weights or confidence levels. In short, it provides a method for passing a descriptive indication of why a particular record was found.

.Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70392[_User-defined Table 0392 – Match reason_] in Chapter 2C, Code Tables, for suggested values.

==== 5.5.5.3 QRI-3 Algorithm Descriptor (CWE) 01438 

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains a text value indicating the name or identity of the specific search algorithm to which the _RCP-5 Search confidence threshold_ and the _QRI-1 Candidate confidence_ refer. Note that there are sometimes significant differences among the algorithms in their numeric scales (e.g., one is 0-100, another might be 10 – 20) as well as their meanings of the same value (two algorithms with an 80% match might not return the same records). Refer to _file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70393[User-defined Table 0393 – Match algorithms]_ in Chapter 2C, Code Tables, for suggested values.

Example: |MATCHWARE_1.2^^HL70393| or |LINKSOFT_2.01^^HL70393|

One use of this optional field is in Patient Look-up transactions where the searching system employs a numeric algorithm for determining potential matches to patient/person look-ups.

=== 5.5.6 RCP – Response Control Parameter segment 

The RCP segment is used to restrict the amount of data that should be returned in response to query.

HL7 Attribute Table – RCP[#RCP .anchor]#### – Response Control Parameter

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 |1..1 | |ID |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70091[0091] |00027 |Query Priority
|2 | | |CQ |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70126[0126] |00031 |Quantity Limited Request
|3 | | |CNE |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70394[0394] |01440 |Response Modality
|4 | | |DTM |C | | |01441 |Execution and Delivery Time
|5 |1..1 | |ID |O | |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70395[0395] |01443 |Modify Indicator
|6 | | |SRT |O |Y | |01624 |Sort-by Field
|7 |1..256 | |ID |O |Y |file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70391[0391] |01594 |Segment group inclusion
|===

==== 5.5.6.0 RCP field definitions

==== 5.5.6.1 RCP-1 Query Priority (ID) 00027 

Definition: This field contains the time frame in which the response is expected. Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70091[_HL7 Table 0091 – Query priority_] in Chapter 2C, Code Tables, for valid values. Table values and subsequent fields specify time frames for response.

==== 5.5.6.2 RCP-2 Quantity Limited Request (CQ) 00031

Components: <Quantity (NM)> ^ <Units (CWE)>

Subcomponents for Units (CWE): <Identifier (ST)> & <Text (ST)> & <Name of Coding System (ID)> & <Alternate Identifier (ST)> & <Alternate Text (ST)> & <Name of Alternate Coding System (ID)> & <Coding System Version ID (ST)> & <Alternate Coding System Version ID (ST)> & <Original Text (ST)> & <Second Alternate Identifier (ST)> & <Second Alternate Text (ST)> & <Name of Second Alternate Coding System (ID)> & <Second Alternate Coding System Version ID (ST)> & <Coding System OID (ST)> & <Value Set OID (ST)> & <Value Set Version ID (DTM)> & <Alternate Coding System OID (ST)> & <Alternate Value Set OID (ST)> & <Alternate Value Set Version ID (DTM)> & <Second Alternate Coding System OID (ST)> & <Second Alternate Value Set OID (ST)> & <Second Alternate Value Set Version ID (DTM)>

Definition: This field contains the maximum length of the response that can be accepted by the requesting system. Valid entries are numerical values (in the first component) given in the units specified in the second component. Default is LI (lines).

Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70126[_HL7 Table 0126 – Quantity limited request_] in Chapter 2C, Code Tables, for valid entries for the second component. In a segment pattern response, a line is defined as a single segment.

==== 5.5.6.3 RCP-3 Response Modality (CNE) 01440 

Components: <Identifier (ST)> ^ <Text (ST)> ^ <Name of Coding System (ID)> ^ <Alternate Identifier (ST)> ^ <Alternate Text (ST)> ^ <Name of Alternate Coding System (ID)> ^ <Coding System Version ID (ST)> ^ <Alternate Coding System Version ID (ST)> ^ <Original Text (ST)> ^ <Second Alternate Identifier (ST)> ^ <Second Alternate Text (ST)> ^ <Name of Second Alternate Coding System (ID)> ^ <Second Alternate Coding System Version ID (ST)> ^ <Coding System OID (ST)> ^ <Value Set OID (ST)> ^ <Value Set Version ID (DTM)> ^ <Alternate Coding System OID (ST)> ^ <Alternate Value Set OID (ST)> ^ <Alternate Value Set Version ID (DTM)> ^ <Second Alternate Coding System OID (ST)> ^ <Second Alternate Value Set OID (ST)> ^ <Second Alternate Value Set Version ID (DTM)>

Definition: This field specifies the timing and grouping of the response message(s). Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70394[_HL7 Table 0394 – Response modality_] in Chapter 2C, Code Tables, for valid values.

==== 5.5.6.4 RCP-4 Execution and Delivery Time (DTM) 01441 

Definition: Specifies the time the response is to be returned. This field is only valued when _RCP-1-Query priority_ contains the value *D* (Deferred).

==== 5.5.6.5 RCP-5 Modify Indicator (ID) 01443 

Definition: This field specifies whether the subscription is new or is being modified. Refer to _file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70395[HL7 Table 0395 – Modify indicator]_ in Chapter 2C, Code Tables, for valid values.

==== 5.5.6.6 RCP-6 Sort-by Field (SRT) 01624 

Components: <Sort-by Field (ST)> ^ <Sequencing (ID)>

Definition: For queries requesting a tabular response, this field specifies by which fields the response is to be sorted, and the order(s) in which sorting is to be performed. When the QSC variant is not in use, the values specified for the first component in this field are derived from the ColName field of the Output Specification and Commentary; see section _5.3.3.1_, "_Query Profile template for query with tabular response_." When the QSC variant is used, the values are derived from the ColName field of the Input/Output Specification and Commentary; see section _5.9.4.1_, "_Pharmacy example_" for an example.

Each repetition of this field specifies a single sort field. Thus, the first repetition of this field specifies the primary sort field; the second repetition specifies the secondary sort field; etc.

==== 5.5.6.7 RCP-7 Segment Group Inclusion (ID) 01594 

Definition: Specifies those optional segment groups which are to be included in the response. Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70391[_HL7 Table 0391—Segment group_] in Chapter 2C, Code Tables, for values for Segment Group. This is a repeating field, to accommodate inclusion of multiple segment groups. The default for this field, not present, means that all relevant groups are included.

=== 5.5.7 RDF – Table Row Definition segment

The RDF segment defines the content of the row data segments (RDT) in the tabular response (RTB).

As an optional segment in a query either a QBP or QBS, this segment can be used to limit the number of columns returned and to specify what column positions the fields occupy (where supported, these features can be used to override the defaults for the particular query). If omitted, all fields defined for the query are returned in their default column order.

As a required segment in a tabular response (RTB) to either a QBP or QBS, this segment defines the contents of the table row data (RDT) segments that follows. It is not necessarily an echo back of the segment as it appeared in the query.

HL7 Attribute Table – RDF[#RDF .anchor]#### – Table Row Definition

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1 | |3= |NM |R | | |00701 |Number of Columns per Row
|2 | | |RCD |R |Y |E:\\V2\\v2.9 final Nov from Frank\\V29_CH02C_Tables.docx#HL70440[0440] |00702 |Column Description
|===

==== 5.5.7.0 RDF field definitions

==== 5.5.7.1 RDF-1 Number of Columns per Row (NM) 00701

Definition: This field specifies the number of data columns (and therefore the number of fields) contained within each row of returned data.

==== 5.5.7.2 RDF-2 Column Description (RCD) 00702

Components: <Segment Field Name (ST)> ^ <HL7 Data Type (ID)> ^ <Maximum Column Width (NM)>

Definition: Each repetition of this field consists of three components:

The segment field name that identifies the field occupying the column. The segment field name SHALL agree with the column name as it appears in the Query Profile. Use of the @ sign as prefix to the column name is optional.

The 2 or 3 character HL7 data type, as defined in Chapter 2. Refer to file:///E:\V2\v2.9%20final%20Nov%20from%20Frank\V29_CH02C_Tables.docx#HL70440[_HL7 Table 0440 – Data types_] in Chapter 2C, Code Tables, for valid values.

The maximum width of the column, as dictated by the responding system. (This may vary from the HL7-defined maximum field length.)

=== 5.5.8 RDT – Table Row Data segment

The RDT segment contains the row data of the tabular data response message (TBR).

HL7 Attribute Table – RDT[#RDT .anchor]#### – Table Row Data

[width="100%",cols="14%,6%,7%,6%,6%,6%,7%,7%,41%",options="header",]
|===
|SEQ |LEN |C.LEN |DT |OPT |RP/# |TBL# |ITEM# |ELEMENT NAME
|1-n |. | |varies |R | | |00703 |Column Value
|===

==== 5.5.8.0 RDT field definitions

==== 5.5.8.1 RDT-1 Column Value (varies) 00703

Definition: This field is a requested field. Fields occur in the position order defined for the query or table (unless overridden by an optional RDF segment on a stored procedure request or Virtual Table query message), separated by field delimiters.

== 5.6 AUXILIARY QUERY PROTOCOLS

This section discusses properties of queries that can be described as global properties. These properties enable the Client and Server to deal with timing and sizing issues and to handle exceptions.

=== 5.6.1 Immediate vs. deferred response

Responses to queries can be either immediate or deferred. In the immediate mode, the responding process gives the response immediately or in a short period during which the requesting process will wait for the response. In the deferred mode, the response is returned asynchronously, as a separate message pair. Also, a time interval for the deferred transaction may be specified.

In the case of immediate mode query, the Server does NOT send a General Acknowledgement (ACK). The acknowledgement of the query is contained within the response message. In the case of deferred mode, the query is acknowledged immediately by an ACK. The Server sends the deferred response at the appropriate time. The Client acknowledges the response with an ACK. In short, the deferred query transaction consists of 2 "round trips."

If an immediate mode query message is malformed, a negative ACK is immediately sent.

Use cases for Deferred Response include:

____
{empty}1) evaluate the query conditions at a certain point in time and then return the response. For example, "At 9 AM tomorrow, evaluate query and return response";

{empty}2) produce a large report to be communicated to the Server at an off-peak hour. For example, a response which contains all admissions records for the month to be sent at 4:00 a.m., or a reference lab results listing to be sent at noon. A deferred response can benefit both Server and Client in such cases, especially where the generation, communication, and receipt of segments can all be done at times of otherwise low-volume processing.
____

If the Query Profile indicates that the Server will support both immediate and deferred responses, then the Client may indicate the desired value of this property by sending it in the _RCP-1 Response priority_ field. If the Server supports only one response type, then the value specified by the Client SHALL agree.

image:extracted-media/media/image2.wmf[extracted-media/media/image2]

The following examples demonstrate how the same query could be invoked in either immediate or deferred mode.

==== 5.6.1.0 hiddentext

==== 5.6.1.1 Immediate response

The Client submits the following query and indicates that an immediate response is desired by setting _RCP-1-Response priority_ to "I".

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Q42^QBP_Q13|ACK9901|P|2.8||||||||

QPD|Q42^Tabular Dispense History^HL70471|Q0010|555444222111^^^MPI^MR| |19980531|19990531|

RCP|I|999^RD|

RDF|3|PatientList^ST^20~PatientName^XPN^48~MedicationDispensed^ST^40~RXD.3^DTM^24

The Server responds one minute later.

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201401-0800||RTB^K42^RTB_K13|8858|P|2.8||||||||

MSA|AA|8699|

QAK|Q010|OK|Q42^Tabular Dispense History^HL7nnn|4

QPD|Q42^Tabular Dispense History^HL7nnn|Q0010|555444222111^^^MPI^MR||19980531|19990531|

RDF|7|PatientId^CX^20~PatientName^XPN^48~OrderControlCode^ID^2~ MedicationDispensed^CWE^100~DispenseDate^DTM^24~QuantityDispensed^NM^20~ OrderingProvider^XCN^120

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|525440345^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00172409660^BACLOFEN 10MG TABS^NDC |199809221415-0700|10|88^Seven^Henry^^^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|99^Assigned^Amanda^^^DR^MD

==== 5.6.1.2 Deferred response example

The Client submits the following query and indicates that a deferred response is desired by setting _RCP-1-Response priority_ to "D".

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Q42^QBP_Q13|ACK9901|P|2.8||||||||

QPD|Q42^Tabular Dispense History^HL7nnn|Q0010|555444222111^^^MPI^MR| |19980531|19990531|

RCP|D|999^RD|

RDF|3|PatientList^ST^20~PatientName^XPN^48~MedicationDispensed^ST^40~RXD.3^DTM^24

The Server responds one minute later with a general acknowledgement.

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201401-0800||ACK^Q42^ACK|8875|P|2.8||||||||

MSA|AA|8699|

The Server responds the following morning with the desired data.

MSH|^~\&|PIMS|Gen Hosp|PCR||199811210300-0800||RTB^K42^RTB_K13|9950|P|2.8||||||||

QAK|Q010|OK|Q42^Tabular Dispense History^HL7nnn|4

QPD|Q42^Tabular Dispense History^HL7nnn|Q0010|555444222111^^^MPI^MR||19980531|19990531|

RDF|7|PatientId^CX^20~PatientName^XPN^48~OrderControlCode^ID^2~ MedicationDispensed^CWE^100~DispenseDate^DTM^24~QuantityDispensed^NM^20~ OrderingProvider^XCN^120

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|525440345^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00172409660^BACLOFEN 10MG TABS^NDC |199809221415-0700|10|88^Seven^Henry^^^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|99^Assigned^Amanda^^^DR^MD

The Client responds immediately with a general acknowledgement.

MSH|^~\&|PCR|Gen Hosp|PIMS||199811210300-0800||ACK^K42^ACK|8750|P|2.8||||||||

MSA|AA|9950|

=== 5.6.2 Query cancellation

Canceling a query is equivalent to canceling an order in that it is asking the discontinuation of a request for which a response may already be on its way. In the case of an interactive query, a cancellation request is a courtesy on the part of the Client, but not strictly required. How long the query will stay open is an implementation issue.

Although the effect to the Client is the same as if it had not sent any message (no further query data is received), receipt of this message by the Server enables it to discard any unsent continuation data that might be queued.

MSH|^~\&|||||||QCN^Jnn^QCN_J01|...

QID|Q001|Q99^SomeQuery^0003|...

...

=== 5.6.3 Interactive continuation of response messages

The Interactive Continuation Protocol defines the methodology for the intentional transmission of a large query-response payload over multiple HL7 messages. Without this protocol, the response would be returned in a single large logical message.

The protocol is called interactive because there is an ongoing dialog between the Client and the Server. The dialog commences when the Client issues a query for a potentially large amount of data, but specifies in the _RCP-2-Quantity limited request,_ that only a limited amount of data is to be returned in each continued response. The Server then returns one response message containing data up to the requested quantity. The Client may continue to ask for further subsets of the data until the entire set is exhausted or may choose to cancel the query.

This use of the term "continuation" responses in queries should not be confused with its use in continuing an unsolicited fragmented message. In the case of continuing a response to query the control is on the side of the querying application and there is an explicit cancellation event. In the case of continuation of an unsolicited message, the control is on the part of the sending application and there is no concept of canceling the message transmission.

Segment fragmentation and message fragmentation are discussed in Chapter 2.

==== 5.6.3.0 hiddentext

==== 5.6.3.1 Interactive continuation algorithm and rules

The rules for the interactive continuation (of a query response) are as follows:

If the Server is sending a subset of the data, the message is terminated with a DSC segment with the _DSC-1-Continuation pointer_ set to the appropriate pointer value and the _DSC-2 -Continuation type_ set to "I".

If the Client wishes to receive the next installment, the query is sent again with a DSC segment following the RCP. The _DSC-1-Continuation pointer_ echoes the value sent by the Server.

The Server continues to send installments in response to the Client's request until there is no more data. The end of data is signified by the absence of the DSC segment OR an empty value in _DSC-1-Continuation pointer_.

If the Client wishes to cancel the query before the end of the data is reached, a Cancel query is sent.

In addition to _DSC-1-Continuation pointer_, _QAK-1-Query tag_ may be used to confirm to the Client which query instance the Server is responding to, since the Client may not be relied upon to have retained the text of each query message and continuation request.

The value of _MSH-10-Message control ID_ will be different for every message sent by the Client (i.e., the initial query and each continuation request). Thus the value of _MSA-2-Message control ID_ for each message sent by the Server (which echoes the value of _MSH-10-Message control ID_ from the Client) will vary among multiple response payload messages. By contrast, _QAK-1-Query tag_ will remain the same across all response payload messages to a given query instance.

==== 5.6.3.2 Use case

One use of queries is to retrieve data from one application for presentation to users of another. This approach might be used for users of a patient care system retrieving data from lab or other ancillaries. It also might permit users of a pharmacy system to retrieve a patient's lab results from the lab system or non-pharmacy order data from the patient care system. Almost any other application system could be the source of data or the system initiating the query for its users.

Of particular interest is the case where the inquiring user formulates the query online at the terminal of one system and waits while that system sends the query to another. The inquiring user gets the response and displays it at their terminal. The user formulating such a query may only have limited understanding of what data is available for a given patient. Sometimes the user's preference would be to make a simple query such as "give me recent data in reverse chronological sequence" rather than "give me data for yesterday," since there may be some data available for today, or there may be data from two days ago that is of interest. The user will look at the data returned and simply quit looking at it after finding the part that is of interest. (The time frames or the sort sequence may differ, or the user may wish to impose some selectivity on the response, but the general principle remains the same. The user would prefer to make a vague statement of the interest, have the data presented in order of decreasing likelihood of interest, and quit when he or she has seen enough.)

While beneficial to the user, this way of requesting data could be very burdensome when the resulting query takes place over an inter-application interface. If the Server were to retrieve, format, and send all the data the user might like to see, the processing load would be extremely high and the response time unacceptable.

The interactive continuation protocol provides a way to permit the users to formulate queries loosely while limiting the processing burden on the Server. The Client specifies the general constraints of the query and an amount of data to be returned. (For example, the query might be for lab results for patient #12379 and 44 lines would be requested.) The Server retrieves and formats the specified amount of data and returns it with a special key field, _DSC-1-Continuation pointer_. The Server presents the requested data to the user and retains the continuation pointer field for use if another query is needed. The internal structure of the value is not known to the Client.

If, after viewing the data, the user requests more, the Client sends the query again in a format that is identical with the first, except that _DSC-1-Continuation pointer_ value is included and the requested amount of data may be changed. The Server may use the continuation pointer field as a key into its database to continue retrieval and formatting of the results. If the user does not request more data, no further messages are exchanged.

The initiating system may also explicitly terminate the query by sending a QCN^J01 (cancel query) message. Receipt of the QCN^J01 message by the responding system enables it to discard any unsent continuation data that might be queued.

==== 5.6.3.3 Example of interactive continuation protocol

The user wishes to know all the medications dispensed for the period between January 1, 1998, and December 31, 1999, for the patient whose medical record number is "555444222111". The Client submits the following query and invokes the interactive continuation protocol. Note that the quantity has been limited to 8 lines.

MSH|^~\&|PCR|Gen Hosp|IE||200009171400-0800||QBP^Q41^QBP_Q15|8699|P|2.8||||||||

QPD|Q41^DispenseHistory^HL7nnnn|Q001|555444222111^^^MPI ^MR||19980101|19991231|

RCP|I|8^LI|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 7 prescription dispenses meeting the criteria. As shown in the following response, eight lines of data are returned as requested. The response ends with a DSC segment showing the continuation pointer and the indication that this is a logical breaking point.

MSH|^~\&|PIMS|Gen Hosp|PCR||200009171401-0800||RDY^R41^RDY_K15|8858|P|2.8||||||||

MSA|AA|8699|

QAK|Q001|OK|Q41^DispenseHistory^HL7nnnn|^8

QPD|Q41^DispenseHistory^HL7nnnn|Q001|555444222111^^^MPI^MR||19980101|19991231|

DSP||| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:09-17-00

DSP||| DISPENSE HISTORY REPORT PAGE 1

DSP|||MRN Patient Name MEDICATION DISPENSED DISP-DATE

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL 120 mg TAB 10/12/1999

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL ER TAB 180MG 09/21/1999

DSP|||555444222111 Everyman,Adam BACLOFEN 10MG TABS 08/22/1999

DSP|||555444222111 Everyman,Adam THEOPHYLLINE 80MG/15ML SOL 05/29/1999

DSP||| << END OF Screen>>

DSC|77|I|

The Client wishes to receive another payload. [multiblock footnote omitted]

MSH|^~\&|PCR|Gen Hosp|IE||199811201405-0800||QBP^Q41^QBP_Q15|8890|P|2.8||||||||

QPD|Q41^DispenseHistory^HL7nnnn|Q001|555444222111^^^MPI^MR||19980101|19991231|

RCP|I|8^LI|

DSC|77|I|

The Server returns the next payload and indicates in _QAK-4-Hit count_ that this is the last of the data..

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201407-0800||RDY^K15^RDY_K15|8898|P|2.8||||||||

MSA|AA|8890|

QAK|Q001|OK|Q41^DispenseHistory^HL7nnnn|^7^^Y|

QPD|Q41^DispenseHistory^HL7nnnn|Q001|555444222111^^^MPI^MR||19980101|19991231|

DSP||| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:09-17-99

DSP||| DISPENSE HISTORY REPORT PAGE 1

DSP|||MRN Patient Name MEDICATION DISPENSED DISP-DATE

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL 120 mg TAB 05/29/1998

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL ER TAB 180MG 04/21/1998

DSP|||555444222111 Everyman,Adam BACLOFEN 10MG TABS 04/22/1998

DSP||| << END OF REPORT>>

The query/response is now completed.

==== 5.6.3.4 Message fragmentation example

Query responses, like unsolicited updates, may need to force the continuation of a message, or even a segment, across multiple physical messages. This is more precisely described as fragmenting. Fragmentation is discussed in detail in Chapter 2. Those aspects pertaining to how this would apply to a query response are repeated here for the reader's convenience.

The Client requests the last chest x-ray for the patient whose medical record number is 555444222111. The following query is submitted.

MSH|^~\&|CIS||RAD||199910180900-0700||QBP^Q61^QBP_Q11|7777|P|2.7|

QPD|Q61^Radiology Result^HL7nnnn|Q98|555444222111^^^^MR|

RCP|I|

The Server returns the following response but the OBX segment that contains a DICOM image overflows its buffer. The segment is fragmented as follows:

MSH|^~\&|RAD||CIS||||RSP^K61^RSP_K61|5555|P|2.8|

MSA|AA|7777|

QAK|Q98|OK|Q61^Radiology Result^HL7nnnn|

QPD|Q61^Radiology Result^HL7nnnn|Q98|555444222111^^^^MR|

PID|||5554442221111^^^^MR|

ORC

OBR

OBX||ED|13^^L||abcdefghij|

ADD|

DSC|99|F|

The Client returns an ACK upon receipt of the response.

MSH|^~\&|CIS||RAD||||ACK^K61^ACK|7780|P|2.8|

MSA|AA|5555|

The Server sends the following continued response. Note that the ADD segment will contain the remainder of the data from the fragmented segment. The response then continues on as normal.

MSH|^~\&|RAD||CIS||||RSP^K61^RSP_K61|5560|P|2.7||99|

ADD|klmnop|

OBX|

...

The Client returns an ACK upon receipt of the response.

MSH|^~\&|CIS||RAD||||ACK^K61|7782|P|2.8|

MSA|AA|5560|

=== 5.6.4 Batch message as a query response

The HL7 query also can be used to query for a batch in the following manner:

{empty}a) Use the value B of _RCP-3-Response modality_ to specify a batch response.

*Note:* If using old style query mode, the value BB or BL of _QRD-5-Deferred response type_ may be used to specify a batch response. The query will be acknowledged with a general acknowledgment as in the Deferred Access example above

{empty}b) In addition, insert into the batch file the query defining and RCP segments as follows:

[width="100%",cols="24%,76%",]
|===
|[FHS] |(file header segment)
|\{ |
|[BHS] |(batch header segment)
|QPD |Query defining segment Note: if using old style query mode, the QRD and QRF segments may be used.
|[RCP] |
|\{ |
|MSH |(one or more HL7 messages)
|.... |
|.... |
|.... |
|} |
|[BTS] |(batch trailer segment)
|} |
|[FTS] |(file trailer segment)
|===

{empty}c) The acknowledgment of a batch is described in Chapter 2.

{empty}d) The Query Profile should stipulate if the batch modality is supported.

=== 5.6.5 Query error response

A query/response error can occur at 3 levels:

Communication failure (broken connection, timeout)

Malformed message (message reject)

Malformed query (application error)

If the application receiving the query detects an error while processing the query, the preferred method of response is to return an Application Error (AE) or Application Reject (AR) condition in the _MSA-1-Acknowledgement code_ of the applicable query response message. Further description of the error code is to be included in _ERR-1-Error code and location_. Note that _MSA-6-Error condition_ is retained for backward compatibility for those applications not using the ERR segment. Thus far, this method is consistent with the methods used elsewhere for reporting errors in acknowledgement messages, irrespective of the type of message being acknowledged. In addition, because this is a query response, it is important to include the QAK segment because it specifies the query tag that will identify the particular query instance that was in error. This is of particular importance where a query response may span more than one message.

In summary, use the ERR segment to describe the error if the message fails because of

a malformed message

a malformed query – problem with query tag, problems with parameters

The ERR segment supersedes _QAK-2-Query response status_.

There are 3 common situations that can arise in a query error response:

*Situation 1: Malformed Message*

The query message itself is bad. The parser does not get to the actual query content. Something is wrong with the envelope, i.e., the message is malformed.

The only response is a negative ACK message containing the MSH, MSA and the ERR. That is, the Server creates an ACK message with AR in _MSA-1-Acknowledgement code_ in the above sentence. The dialogue is ended.

*Situation 2: Malformed Query*

The query message got to the Server and is legitimate, but the Server cannot process the query for some reason, i.e., the query is malformed.

The Response message indicates a negative acknowledgement and shows the problem in the ERR. The response message contains the MSH, MSA, ERR, QAK and the query defining segment if available. That is, the Server creates an ACK message with AE in _MSA-1-Acknowledgement code_ in the above sentence. The rest of the message is absent.

Note that the continuation (DSC) segment is not sent or, if it is, its continuation pointer field (_DSC-1-Continuation pointer_) is null.

*Note:* The use of AE (application error) and AR (application reject) codes in _QAK-2-Query response status_ has been deprecated in favor of the ERR segment.

*Situation 3: No data found*

The query is well formed, but there is no data to be returned by the query. This is not strictly an error condition. This example clarifies the protocol to be followed.

The Response message contains MSH, MSA, QAK, and query defining segment. The QAK would indicate "no records found". The rest of the message is absent, i.e., no blank rows or segments are sent.

*Note:* If the responding application successfully processes the query, but is unable to find any qualifying data, this is not an error condition. The responding application returns an Application Accept (AA) in the MSA segment of the query response message, but does not return any data segments (DSP, RDT, or iterations of the items that are counted in hit counts). The continuation (DSC) segment is not sent or, if it is, its continuation pointer field (_DSC-1- Continuation pointer_) is null. If the QAK segment is being used, the field _QAK-2-Query response_ status is valued with NF (no data found, no errors).

== 5.7 PUBLISH AND SUBSCRIBE

This section outlines the framework/process of the publish and subscribe machinery.

=== 5.7.1 Introduction

"Publish and subscribe" refers to the ability of one system, the "Publisher", to offer a data stream that can be sent to recipient systems upon subscription. In one sense, the entire HL7 unsolicited update paradigm, in which the sender sends out a stream of messages to recipients, is a kind of publish and subscribe mechanism. Subscriptions to unsolicited updates are established at interface set-up time when analysts on both sides agree to start sending a stream of data.

This section describes a mechanism by which the Publisher defines a stream of data, but also agrees to selectively subset the message stream based on query-like data constraints. In the normal case, the right of the Subscriber to subscribe is decided at interface setup time. At runtime, the Subscriber controls the data rules under which it sends messages.

Runtime subscription has existed in earlier versions of HL7, but little attention has been drawn to it. Original mode queries could define an open ended time interval in _QRF-9-When quantity/timing qualifier_. The unexplained semantics of this field had been interpreted to mean: If the QRF-9 specified an end time in the future, then the source system would keep sending results using the query continuation protocol.

This section elaborates on such a mechanism, and more cleanly ties the selective filtering into the whole query facility.

=== 5.7.2 Details

Subscription is a process/protocol that allows one system to request that prospective data be sent for a specified period of time, or for an open-ended period of time until further notice. It allows a message stream to be selectively filtered by a query-like mechanism. Specific messages have been defined for subscription and the canceling of a subscription.

A Publisher is one who possesses and transmits streams of data. The Publisher might be a mediator or a broker, such as an interface engine. The Publisher is not necessarily the system that collected the data, but it is the system willing to transmit it

With traditional "unsolicited update subscriptions" a Publisher sends the entire data stream to the recipients. A Publisher normally transmits unfiltered data. However, the Publisher may agree to selectively filter the stream of data within parameters as defined by analysts. For each filterable stream, the Publisher defines a Query Profile that lists the data values that may be used in the filter expression, and defines the segment pattern for the messages that are selected.

If supported in the Query Profile, a subscription may be modified at a later date. _RCP-6-Modify indicator_ is set to "M", and the Action Code parameter is set to "A" or "D" as appropriate. If modification is allowed, the Server bears responsibility for maintaining the filter list. If, as is usually the case, the onus of retaining the filters is on the Client, modification is not allowed and would not be part of the Query Profile.

=== 5.7.3 Examples

A lab system normally sends all reports to the central archive. To provide better service to other departments, the Lab decides to offer a filtered stream in addition to the full stream going to the archive.

The lab decides that it will allow recipients to select based on the MRN of the patient, on the type of study (OBR-4), and on the ordering provider (OBR-16). It names this filtered stream "ORU-Subscription" and writes a conformance specification.

At interface setup time, permission is given for four systems, CommunityNorth, CommunitySouth, CommunityEast and CommunityWest to receive this filtered stream.

The Query Profile for this published filtered stream might be:

==== 5.7.3.0 hiddentext

==== 5.7.3.1 Example of a publish and subscribe Query Profile

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Publication ID (Query ID=Z83): |Z83
|Type: |Publish
|Publication Name: |ORU Subscription
|Query Trigger (= MSH-9): |QSB^Z83^QSB_Q16
|Query Mode: |Both
|Response Trigger (= MSH-9): |ORU^R01^ORU_R01
|Query Characteristics: |Returns lab results reports for the patient(s) as constrained in the input parameters.
|Purpose: |Sends Lab Results, either filtered or unfiltered, as specified in the input parameters.
|Response Characteristics: a|
A standard query response is not received from the server. Instead, actual ORU messages are returned corresponding to the constraints expressed in the input parameters.

The input parameters are ANDed when selecting data to be returned. That is, all input parameters that are specified SHALL be satisfied in order for a result report to be sent.

|Based on Segment Pattern: |R01
|===

QSB^Z83^QSB_Q16: Query Grammar: QSB Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec. Ref
|MSH |Message Header Segment | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

See the definition of the ORU^R01 Message Structure in Chapter 7, section 7.3.1, ORU – Unsolicited Observation Message (Event R01).

*QPD Input Parameter Specification*

[width="100%",cols="15%,17%,7%,5%,5%,5%,4%,5%,6%,5%,8%,8%,10%",options="header",]
|===
|Field Seq (Query ID=Z83) |ColName a|
Key/

Search

|Sort |LEN |DT |Opt |RP/# |Match Op |TBL # |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |Message Query Name
|2 |QueryTag | | |32 |ST |R | | | | | |Query Tag
|3 |MRN | | | |CX |O |Y | | |PID.3 | |
|4 |ActionCode | | | |ID |O | | |0323 | | |
|5 |PatientLocation | | | |PL |O |Y | | |PV1.3 | |
|6 |HospitalService | | | |CWE |O |Y | | |PV1.10 | |
|7 |SRVC | | | |CWE |O |Y | | |OBR.4 | |
|8 |PVDR | | | |CN |O |Y | | |OBR.16 | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z83) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z83^ORU Subscription^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|MRN | |CX |One or more patient identifiers may be sent. When a list is provided, results will be sent if any parameter matches any ID known for a patient. Sending no value matches all patients
|ActionCode | |ID |If the subscription is being modified, the desired action e.g., Add or Delete is carried in this field.
|PatientLocation | |PL |When a list is provided, results will be sent if any parameter matches PV1.3 for any result. Sending no value matches all results.
|HospitalService | |CWE |When a list is provided, results will be sent if any parameter matches PV1.10 for any result. Sending no value matches all results.
|SRVC | |CWE |When a list is provided, results will be sent if any parameter matches OBR.4 for any result.. Sending no value matches all results.
|PVDR | |CN |When a list is provided, results will be sent if any parameter matches OBR.16 for any result.. Sending no value matches all results.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,26%,11%,6%,7%,37%",options="header",]
|===
|Field Seq (Query ID=Z99) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**Ch**aracters, **Li**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|7 |Segment group inclusion | |256 |ID |What segment group(s) are to be included. If this field is not valued, all segment groups will be included.
|===

=== 5.7.4 Establishing a subscription

To establish the subscription to see lab results for two patients, an authorized Subscriber (e.g., CommunityWest) would send a query message with event code Q99:

MSH|^~\&|CPR|COMWEST|PS^LAB||||QSB^Q99^QSB_Q16|8888|P|2.8|

QPD|Q99^ORU_Subscription^HL7nnnn|Q0044|1234^^^MPI^MR~4567^^^MPI^MR|

RCP||||||N|

As results are generated by the Lab, they are all sent to the archive. In addition, the Lab has a list of all subscription requests (such as the message, above). For each message, it checks the query filters associated with the subscription against the message being considered. If the message matches the query, it is sent to the recipient.

For example, a hit on patient 4567 would result in the message:

MSH|^~\&|PS^LAB||CPR|COMWEST||||ORU^R01^ORU_R01|4409|P|2.8|

PID|||4567^^^MPI^MR|....

OBR|....

OBX|...

*Note:* The result message has message type ORU^R01^ORU_R01 (as specified by the Query Profile).

=== 5.7.5 Canceling a subscription

Canceling a subscription is analogous to canceling a query. See sections 5.4.6 and 0.

The template would be as follows:

MSH|^~\&|||||||QSX^Jnn^QSX_J01|

QID...

To cancel the subscription cited in the previous section, CommunityWest would send a cancel message with event code J99:

MSH|^~\&|CPR|COMWEST|PS^LAB||||QSX^J99^QSX_J01|

QID|Q0044|Q99^ORU_Subscription^HL70003|

== 5.8 QUERY IMPLEMENTATION CONSIDERATIONS

Implementation issues are discussed in section 5.2.

== 5.9 QUERY/RESPONSE MESSAGE EXAMPLES

=== 5.9.1 Query by parameter (QBP) / segment pattern response (RSP) 

==== 5.9.1.0 hiddentext

==== 5.9.1.1 Proposed dispense history example and Query Profile

Example: The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following QBP message is generated:

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Z81^QBP_Q11|ACK9901|P|2.8||||||||

QPD|Z81^Dispense History^HL7nnnn|Q001|555444222111^^^MPI^MR||19980531|19990531|

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses for the period beginning 5/31/98 and ending 5/31/99and returns the following RSP message:

MSH|^~\&|PIMS|Gen hosp|PCR||199811201400-0800||RSP^Z82^RSP_Z82|8858|P|2.8||||||||

MSA|AA|ACK9901|

QAK|Q001|OK|Z81^Dispense History^HL7nnnn|4|

QPD|Z81^Dispense History^HL7nnnn|Q001|555444222111^^^MPI^MR||19980531|19990531|

PID|||555444222111^^^MPI^MR||Everyman^Adam||19600614|M||C|2101 Webster # 106^^Oakland^CA^94612||^^^^^510^6271111|^^^^^510^6277654|||||343132266|||N|||||||||

ORC|RE||89968665||||||199805121345-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^BID^^19980529|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC |120||mgm||||||||||||||||||||||||||

RXD|1|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100|||1331665|3|||||||||||||||||

RXR|PO||||

ORC|RE||89968665||||||199805291030-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^^D100^^20020731^^^TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |100||180MG|TABLET SA|||G|||0|BC3126631^CHU^Y^L||213220929|0|0|19980821|||

RXD|1|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821|100|||213220929|0|TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR||||||||||||

RXR|PO||||

ORC|RE||235134037||||||199809221330-0700|||8877^Hippocrates^Harold^H^III^DR^MD||^^^^^555^555-5001||||||RXD|1|00172409660^BACLOFEN 10MG TABS^NDC|199809221415-0700|10|||235134037|5|AS DIRECTED||||||||||||

RXR|PO||||

ORC|RE||235134030||||||199810121030-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^555^555-5001||||||

RXD|1|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|||235134030|5|AS DIRECTED||||||||||||

RXR|PO

===== 5.9.1.1.1 Associated dispense history Query Profile

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z81): |Z81
|Type: |Query
|Query Name: |Dispense History
|Query Trigger (= MSH-9): |QBP^Z81^QBP_Q11
|Query Mode: |Both
|Response Trigger (= MSH-9): |RSP^Z82^RSP_Z82
|Query Characteristics: |May specify patient, medication, a date range, and how the response is to be sorted.
|Purpose: |To retrieve patient pharmacy dispense history information from the Server.
|Response Characteristics: |Sorted by Medication Dispensed unless otherwise specified in *SortControl.*
|Based on Segment Pattern: |RDS_O01
|===

The QBP_Q11 message structure and related choreography can be found in link:#qbprsp-query-by-parametersegment-pattern-response-events-vary[5.4.1].

RSP^Z82^RSP_Z82: Response Grammar: Pharmacy Dispense Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec. Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|\{ |--- QUERY_RESPONSE begin | |
|[ |--- PATIENT begin | |
|PID |Patient Identification | |3.4.2
|[PD1] |Additional Demographics | |3.4.9
|[\{NTE}] |Notes and Comments (for PID) | |2.15.10
|[ |--- VISIT begin | |
|\{AL1} |Allergy Information | |3.4.6
|PV1 |Patient Visit | |3.4.3
|[PV2] |Patient Visit – Additional Info | |3.4.4
|] |--- VISIT end | |
|] |--- PATIENT end | |
|\{ |--- COMMON_ORDER begin | |
|ORC |Common Order | |
|[\{ |--- TIMING begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING end | |
|[ |--- ORDER_DETAIL begin | |
|RXO |Pharmacy/Treatment Order | |
|[\{NTE}] |Notes and Comments (for RXO) | |2.15.10
|\{RXR} |Pharmacy/Treatment Route | |
|[ |--- TREATMENT begin | |
|\{RXC} |Pharmacy/Treatment Component | |
|[\{NTE}] |Notes and Comments (for RXC) | |2.15.10
|] |--- TREATMENT end | |
|] |--- ORDER_DETAIL end | |
|[ |--- ENCODED_ORDER begin | |
|RXE |Pharmacy/Treatment Encoded Order | |
|[\{ |--- TIMING_ENCODED begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING_ENCODED end | |
|\{RXR} |Pharmacy/Treatment Route | |
|[\{RXC}] |Pharmacy/Treatment Component | |
|] |--- ENCODED_ORDER end | |
|RXD |Pharmacy/Treatment Dispense | |
|\{RXR} |Pharmacy/Treatment Route | |
|[\{RXC}] |Pharmacy/Treatment Component | |
|\{ |--- OBSERVATION begin | |
|[OBX] |Results | |
|[\{NTE}] |Notes and Comments (for OBX) | |2.15.10
|} |--- OBSERVATION end | |
|} |--- COMMON_ORDER end | |
|} |--- QUERY_RESPONSE end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z81) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
| |PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3: Patient Identifier List
| |MedicationDispensed |S |Y |100 |CWE |O | |= | |RXD.2 | |RXD-2: Dispense/Give Code
| |DispenseDate.LL |S |Y |24 |DTM |O | |> +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
| |DispenseDate.UL |S |Y |24 |DTM |O | |< +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|===

*Input Parameter Field Description and Commentary*

[width="100%",cols="22%,11%,6%,61%",options="header",]
|===
|Input Parameter (Query ID=Z81) |Comp. Name |DT |Description
|*MessageQueryName* | |CWE |SHALL be valued *Z81^Dispense History^HL7nnnn*.
|*QueryTag* | |ST |Unique to each query message instance.
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*MedicationDispensed* | |CWE |If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.LL* | |DTM |This is the earliest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.UL* | |DTM |This is the latest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|===

==== 5.9.1.2 Comprehensive pharmacy information examples and Query Profile

The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following QBP message is generated:

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Z85^QBP_Q11|8332|P|2.8||||||||

QPD|Z85^Pharmacy Information Comprehensive^HL7nnnn|Q002|555444222111^^^MPI^MR ||||19980531|19990531||RXO~RXG~RXA|

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses and an electrolytes panel for the period beginning 5/31/98 and ending 5/31/99and returns the following RSP message:

MSH|^~\&|PIMS|Gen hosp|PCR||199811201400-0800||RSP^Z86^RSP_Z86|8858|P|2.8||||||||

MSA|AA|8332|

QAK|Q002|OK|Z85^Pharmacy Information Comprehensive^HL70003|4|

QPD|Z85^Pharmacy Information Comprehensive^HL7nnnn|Q002|555444222111^^^MPI^MR ||||19980531|19990531||RXO~RXG~RXA|

PID|||555444222111^^^MPI^MR||Everyman^Adam||19600614|M||C|2101 Webster # 106^^Oakland^CA^94612||^^^^^510^6271111|^^^^^510^6277654|||||343132266|||N|||||||||

ORC|RE||89968665||||||199805121345-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^BID^^19980529|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC |120||mgm||||||||||||||||||||||||||

RXD|1|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100|||1331665|3|||||||||||||||||

RXR|PO||||

ORC|RE||89968665||||||199805291030-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^^D100^^20020731^^^TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |100||180MG|TABLET SA|||G|||0|BC3126631^CHU^Y^L||213220929|0|0|19980821|||

RXD|1|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821|100|||213220929|0|TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR||||||||||||

RXR|PO||||

ORC|RE||235134037||||||199809221330-0700|||8877^Hippocrates^Harold^H^III^DR^MD||^^^^^555^5555001||||||RXD|1|00172409660^BACLOFEN 10MG TABS^NDC|199809221415-0700|10|||199810310600-0700|5|AS DIRECTED||||||||||||

RXR|PO||||

ORC|RE||235134030||||||199810121030-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^555^5555001||||||

RXD|1|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|||235134030|5|AS DIRECTED||||||||||||

RXR|PO

OBX|1|ST|2951-2^SODIUM^LN||150|mmol/l|136‑148|H||A|F|19850301||199811180700-0800

OBX|2|ST|2823-3^POTASSIUM^LN||4.5|mmol/l|3.5‑5|N||N|F|19850301||199811180700-0800

OBX|3|ST|2075-0^CHLORIDE^LN||102|mmol/l|94‑105|N||N|F|19850301||199811180700-0800

OBX|4|ST|2028-9^CARBON DIOXIDE^LN||27|mmol/l|24‑31|N||N|F|19850301||199811180700-0800

...

Note the use of _OBX-14-Date/time of the observation_ to time the laboratory observations.

===== 5.9.1.2.1 Comprehensive pharmacy information Query Profile

The following is a highly experimental approach to establishing a super segment pattern response to a general purpose query structure. It contains all of the pharmacy information segments as possible inclusions in the response. It differs from previously defined segment pattern queries in that it cuts across multiple related standard HL7 messages although there is a logical hierarchy that can be determined.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z85): |Z85
|Type: |Query
|Query Name: |Pharmacy Information Comprehensive
|Query Trigger (= MSH-9): |QBP^Z85^QBP_Q11
|Query Mode: |Both
|Response Trigger (= MSH-9): |RSP^Z86^RSP_Z86
|Query Characteristics: |May specify patient, medication, a date range, how the response is to be sorted, and what segment groups are to be returned.
|Purpose: |To retrieve patient pharmacy history information from the Server.
|Response Characteristics: |Sorted by Medication Dispensed unless otherwise specified in *SortControl.*
|Based on Segment Pattern: |
|===

The QBP_Q11 message structure and related choreography can be found in link:#qbprsp-query-by-parametersegment-pattern-response-events-vary[5.4.1]

RSP^Z86^RSP_Z86: Response Grammar: Pharmacy Information Comprehensive

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec. Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|\{ |--- QUERY_RESPONSE begin | |
|[ |--- PATIENT begin | |
|PID |Patient Identification | |3.4.2
|[PD1] |Additional Demographics | |3.4.9
|[\{NTE}] |Notes and Comments (for PID) | |2.15.10
|[\{AL1}] |Allergy Information | |3.4.6
|] |--- PATIENT end | |
|\{ |--- COMMON_ORDER begin | |
|ORC |Common Order | |4.5.3
|[\{ |--- TIMING begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING end | |
|[ |--- ORDER_DETAIL begin | |
|RXO |Pharmacy/Treatment Order | |4.14.1
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- ORDER_DETAIL end | |
|[ |--- ENCODED_ORDER begin | |
|RXE |Pharmacy/Treatment Encoded Order | |4.14.4
|[\{ |--- TIMING_ENCODED begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING_ENCODED end | |
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- ENCODED_ORDER end | |
|[ |--- DISPENSE begin | |
|RXD |Pharmacy/Treatment Dispense | |4.14.5
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- DISPENSE end | |
|[ |--- GIVE begin | |
|RXG |Pharmacy/Treatment Give | |4.14.6
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- GIVE end | |
|[ |--- ADMINISTRATION begin | |
|RXA |Pharmacy/Treatment Administration | |4.14.7
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- ADMINISTRATION end | |
|\{ |--- OBSERVATION begin | |
|[OBX] |Results | |7.4.2
|[\{NTE}] |Notes and Comments (for OBX) | |2.15.10
|} |--- OBSERVATION end | |
|} |--- COMMON_ORDER end | |
|} |--- QUERY_RESPONSE end | |
|[DSC] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z85) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3: Patient Identifier List
|4 |OrderControlCode |S | |2 |ID | |Y | |0119 |ORC.1 | |ORC-1: Order Control
|5 |OrderingProvider |S | |120 |XCN | | | | |ORC.12 | |ORC-12: Ordering Provider
|6 |MedicationDispensed |S |Y |100 |CWE |O | |= | |RXD.2 | |RXD-2: Dispense/Give Code
|7 |DispenseDate.LL |S |Y |24 |DTM |O | |> +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|8 |DispenseDate.UL |S |Y |24 |DTM |O | |< +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="22%,11%,6%,61%",options="header",]
|===
|Input Parameter (Query ID=Z85) |Comp. Name |DT |Description
|*MessageQueryName* | |CWE |SHALL be valued *Z85^Pharmacy Information Comprehensive^HL7nnnn*.
|*QueryTag* | |ST |Unique to each query message instance.
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |IS |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*OrderControlCode* | |ID |If this field, ORC.1, is not valued, all values for this field are considered to be a match.
|*OrderingProvider* | |XCN |If this field, ORC.12, is not valued, all values for this field are considered to be a match.
|*MedicationDispensed* | |CWE |If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.LL* | |DTM |This is the earliest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.UL* | |DTM |This is the latest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,27%,11%,7%,7%,35%",options="header",]
|===
|Field Seq (Query ID=Z85) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**Ch**aracters, **Li**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|7 |Segment group inclusion | |256 |ID |What segment group(s) are to be included. If this field is not valued, all segment groups will be included.
|===

=== 5.9.2 Query using QSC variant / segment pattern response examples

==== 5.9.2.0 hiddentext

==== 5.9.2.1 Dispense information example and Query Profile

The following example demonstrates that the same results, as shown in the example in 5.9.1.1, can be obtained using the QSC variant. The difference is how the input parameters are expressed.

The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following message is generated:

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201300-0800||QBP^Z87^QBP_Q11|8698|P|2.8||||||||

QPD|Z87^Dispense Information^HL7nnnn|Q001|@PID.3^EQ^55544422211^AND|@ORC.1^EQ^RE^ mailto:AND|@RXD.3%5eGE%5e199805310000-0800%5eAND|@RXD.3%5eLE%5e199905310000-0800[AND|@RXD.3^GE^199805310000-0800^AND|@RXD.3^LE^199905310000-0800]

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses for the period beginning 5/31/98 and ending 5/31/99 and returns the following RSP message:

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201300-0800||RSP^Z88^RSP_Z88|8857|P|2.8||||||||

MSA|AA|8698|

QAK|Q001|OK|Z87^Dispense Information^HL7nnnn|4

QPD|Z87^Dispense Information^HL7nnnn|Q001|@PID.3^EQ^55544422211^AND~ORC.1^EQ^RE^ mailto:AND~@RXD.3%5eGE%5e199805310000-0800%5eAND~@RXD.3%5eLE%5e199905310000-0800[AND~@RXD.3^GE^199805310000-0800^AND~@RXD.3^LE^199905310000-0800]

PID|||555444222111^^^MPI^MR||Everyman^Adam||19600614|M||C|2101 Webster # 106^^Oakland^CA^94612||^^^^^510^6271111|^^^^^510^6277654|||||343132266|||N|||||||||

ORC|RE||89968665||||||199905121345-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^BID^^19990529|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC |120||mgm||||||||||||||||||||||||||

RXD|1|00378112001^Verapamil Hydrochloride 120 mg TAB^NDC|199905291115-0700|100|||1331665|3|||||||||||||||||

RXR|PO||||

ORC|RE||89968665||||||199905291030-0700|||77^Hippocrates^Harold^H^III^DR^MD||^^^^^510^ 2673600||||||

RXE|1^^D100^^20020731^^^TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC|100||180MG|TABLET SA|||G|||0|BC3126631^CHU^Y^L||213220929|0|0|19990821|||

RXD|1|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC|19990821|100|||213220929|0|TAKE 1 TABLET DAILY –GENERIC FOR CALAN SR||||||||||||

RXR|PO||||

ORC|RE||235134037||||||199809221330-0700|||88^Seven^Henry^^^DR^MD||^^^^^510^ 2673900||||||

RXD|1|00172409660^BACLOFEN 10MG TABS^NDC|199809221415-0700|10|||235134037|5|AS DIRECTED||||||||||||

RXR|PO||||

ORC|RE||235134030||||||199810121030-0700|||99^Assigned^Amanda^^^DR^MD||^^^^^510^ 2673700||||||

RXD|1|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|||235134030|5|AS DIRECTED||||||||||||

RXR|PO

===== 5.9.2.1.1 Associated dispense information Query Profile

Note that the following Query Profile contains many more input parameters. The user is allowed to populate as many of these as desired.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z87): |Z87
|Type: |Query
|Query Name: |Dispense Information
|Query Trigger (= MSH-9): |QBP^Z87^QBP_Q11
|Query Mode: |Both
|Response Trigger (= MSH-9): |RSP^Z88^RSP_Z88
|Query Characteristics: |Selection criteria are chosen from a Virtual Table. May specify patient, medication, and a date range.
|Purpose: |To retrieve patient pharmacy dispense history information from the Server.
|Response Characteristics: |Sorted by Medication Dispensed unless otherwise specified in *SortControl.*
|Based on Segment Pattern: |RDS_O01
|===

QBP^Z87^QBP_Q11: Query Grammar: QBS Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec. Ref
|MSH |Message Header Segment | |2.15.9
|[\{ARV}] |Access Restriction | |3
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- QBP begin | |
|[...] |Optional query by example segments | |
|] |--- QBP end | |
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

RSP^Z88^RSP_Z88: Response Grammar: Pharmacy Information Comprehensive

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec. Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|\{ |--- QUERY_RESPONSE begin | |
|[ |--- PATIENT begin | |
|PID |Patient Identification | |3.4.2
|[PD1] |Additional Demographics | |3.4.10
|[\{NTE}] |Notes and Comments (for PID) | |2.15.10
|[ |--- ALLERGY begin | |
|\{AL1} |Allergy Information | |3.4.5
|[ |--- VISIT begin | |
|PV1 |Patient Visit | |3.4.3
|[PV2] |Patient Visit – Additional Info | |3.4.4
|] |--- VISIT begin | |
|] |--- ALLERGY end | |
|] |--- PATIENT end | |
|\{ |--- COMMON_ORDER begin | |
|ORC |Common Order | |4.5.1
|[\{ |--- TIMING begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING end | |
|[ |--- ORDER_DETAIL begin | |
|RXO |Pharmacy/Treatment Order | |4.8.2
|[\{NTE}] |Notes and Comments (for RXO) | |2.15.10
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[ |--- COMPONENT begin | |
|\{RXC} |Pharmacy/Treatment Component | |4.14.3
|[\{NTE}] |Notes and Comments (for RXC) | |2.15.10
|] |--- COMPONENT end | |
|] |--- ORDER_DETAIL end | |
|[ |--- ORDER_ENCODED begin | |
|RXE |Pharmacy/Treatment Encoded Order | |4.8.7
|[\{ |--- TIMING_ENCODED begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING_ENCODED end | |
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|] |--- ORDER_ENCODED end | |
|RXD |Pharmacy/Treatment Dispense | |4.8.10
|\{RXR} |Pharmacy/Treatment Route | |4.14.2
|[\{RXC}] |Pharmacy/Treatment Component | |4.14.3
|\{ |--- OBSERVATION begin | |
|[OBX] |Results | |7.4.2
|[\{NTE}] |Notes and Comments (for OBX) | |2.15.10
|} |--- OBSERVATION end | |
|} |--- COMMON_ORDER end | |
|} |--- QUERY_RESPONSE end | |
|DSC |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z87) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |SelectionCriteria | | |*255* |*ST* |*R* |*Y* | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="21%,11%,6%,62%",options="header",]
|===
|Input Parameter (Query ID=Z87) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z87^Dispense Information^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|SelectionCriteria | |ST |A query expression whose operands are derived from the 'ColName' column in the 'Input Specification: Virtual Table' given below.
|===

*Input Specification: Virtual Table*

[width="100%",cols="23%,7%,5%,5%,6%,5%,5%,7%,6%,9%,9%,13%",options="header",]
|===
|ColName (Query ID=Z87) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3: Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|OrderControlCode |S | |2 |ID | | | |0119 |ORC.1 | |ORC-1 Order Control
|MedicationDispensed |S |Y |100 |CWE | | | | |RXD.2 | |RXD-2 Dispense/Give Code
|DispenseDate |S | |26 |DTM | | | | |RXD.3 | |RXD-2 Date/Time Dispensed
|QuantityDispensed |L | |20 |NM | | | | |RXD.4 | |RXD-4 Actual Dispense Amount
|OrderingProvider |S | |120 |XCN | | | | |ORC.12 | |ORC-12 Ordering Provider
|===

*Virtual Table Field Description and Commentary*

[width="100%",cols="21%,11%,6%,62%",options="header",]
|===
|ColName (Query ID=Z87) |Comp. Name |DT |Description
|PatientList | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |IS |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|OrderControlCode | |ID |If this field, ORC.1, is not valued, all values for this field are considered to be a match.
|MedicationDispensed | |CWE |If this field, RXD.2, is not valued, all values for this field are considered to be a match.
|DispenseDate | |DTM |If this field, RXD.3, is not valued, all values for this field are considered to be a match.
|QuantityDispensed | |NM |If this field, RXD.4, is not valued, all values for this field are considered to be a match.
|OrderingProvider | |XCN |If this field, ORC.12, is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,27%,11%,7%,7%,35%",options="header",]
|===
|Field Seq (Query ID=Z87) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|7 |Segment group inclusion | |256 |ID |What segment group(s) are to be included. If this field is not valued, all segment groups will be included.
|===

==== 5.9.2.2 Dispense information query showing different instantiation

The following example shows how the same QSC style query can be invoked in a very different way producing very different results.

The user wishes to know all the medications ever dispensed for the patient whose medical record number is "555444222111" prescribed by Dr Lister (provider number 99). The following message is generated. Note that the same Query has been used, but different input specifications were used.

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201300-0800||QBP^Z87^QBP_Q11|8698|P|2.8||||||||

QPD|Q33^Dispense Information^HL7nnnn|Q005| @PID.3^EQ^55544422211^AND|@ORC.1^EQ^RE^AND|@ORC.12.1^EQ^99

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 2 prescription dispenses as prescribed by Dr. Lister. The response is clearly different than the response to the first query.

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201300-0800||RSP^Z88^RSP_Z88|8857|P|2.8||||||||

MSA|AA|8698|

QAK|Q005|OK|Q33^Dispense Information^HL7nnnn|2|

QPD|Q33^Dispense Information^HL7nnnn|Q005| @PID.3^EQ^55544422211^AND~@ORC.1^EQ^RE^AND~@ORC.12.1^EQ^99

PID|||555444222111^^^MPI^MR||Everyman^Adam||19600614|M||C|2101 Webster # 106^^Oakland^CA^94612||^^^^^510^6271111|^^^^^510^6277654|||||343132266|||N|||||||||

ORC|RE||89968665||||||199603121345-0700|||99^Assigned^Amanda^^^DR^MD ||^^^^^510^ 2673600||||||

RXE|1^BID^^19980529|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |120||mgm||||||||||||||||||||||||||

RXD|1|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC|199603122000-0700|100|||1331665|3|||||||||||||||||

RXR|PO||||

ORC|RE||235134030||||||199810121030-0700|||88^PRIMARY^PATRICIA^H^III^DR^MD||^^^^^555^ 5551004||||||

RXD|1|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|||235134030|5|AS DIRECTED||||||||||||

RXR|PO

==== 5.9.2.3 Lab results history example

The user wishes to know all the lab results for the patient whose medical record is 80302641876 and where the result report date/time is between March 21, 1999 and June 24, 1999 and the Lab department is chemistry. This Query Name might be invoked once with a query tag of 123 in the following manner:

MSH|^~\&| PCR|Gen Hosp|LIS.RMS||199907131030-0800||QBP^Z89^QBP_Q11|4460|P|2.8|

QPD|Z89^Lab Results History^HL7nnnn|123|@PID.3.1.1^EQ^80302641876^AND| @OBR.22^GE^19990321^AND|@OBR.22^LE^19990624^AND|@OBR.24^EQ^"CHEMISTRY"

RCP|I||R|

==== *_5.9.2.4_* Lab results history Query Profile

The "Lab Results History" query returns laboratory results information in the form of the Segment Pattern Response corresponding to the ORU^R01 – unsolicited transmission of an observation message. It returns all of the results which meet the criteria defined in the QPD – Query Parameter Definition Segment of the RSP^R11 – Segment Pattern Response message.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z89): |Z89
|Type: |Query
|Query Name: |Lab Results History
|Query Trigger (= MSH-9): |QBP^Z89^QBP_Q11
|Query Mode: |Both
|Response Trigger (= MSH-9): |RSP^Z90^RSP_Z90
|Query Characteristics: |May specify patient, report time, laboratory department, and LOINC code of result to be returned.
|Purpose: |To retrieve patient laboratory results information from the Server.
|Response Characteristics: |
|Based on Segment Pattern: |ORU_O01
|===

QBP^Z89^QBP_Q11: Query Grammar: QBS Message

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header Segment | |2.15.9
|[\{ARV}] |Access Restriction | |3
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- QBP begin | |
|[...] |Optional query by example segments | |
|] |--- QBP end | |
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|[ DSC ] |Continuation Pointer | |2.15.4
|===

RSP^Z90^RSP_Z90: Response Grammar: Pharmacy Information Comprehensive

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|link:#RCP[RCP] |Response Control Parameter | |5.5.6
|\{ |--- QUERY_RESPONSE begin | |
|[ |--- PATIENT begin | |
|PID |Patient Identification | |3.4.2
|[PD1] |Additional Demographics | |3.4.10
|[\{NK1}] |Next of Kin/Associated Parties | |3.4.5
|[\{NTE}] |Notes and Comments (for PID) | |2.15.10
|[ |--- VISIT begin | |
|PV1 |Patient Visit | |3.4.3
|[PV2] |Patient Visit – Additional Info | |3.4.4
|] |--- VISIT end | |
|] |--- PATIENT end | |
|\{ |--- COMMON_ORDER begin | |
|ORC |Common Order | |4.5.1
|[\{ |--- TIMING begin | |
|TQ1 |Timing/Quantity | |4.5.4
|[\{TQ2}] |Timing/Quantity Order Sequence | |4.5.5
|}] |--- TIMING end | |
|OBR |Observations Report ID | |4.5.3
|[\{NTE}] |Notes and Comments (for ORC/OBR) | |2.15.10
|[CTD] |Contact Data | |11.6.4
|\{ |--- OBSERVATION begin | |
|[OBX] |Observation/Result | |7.4.2
|[\{NTE}] |Notes and Comments (for OBX) | |2.15.10
|} |--- OBSERVATION end | |
|} |--- COMMON_ORDER end | |
|[\{ |--- SPECIMEN begin | |
|SPM |Specimen | |7.4.3
|[\{OBX}] |Observation Related to Specimen | |7.4.2
|}] |--- SPECIMEN end | |
|} |--- QUERY_RESPONSE end | |
|DSC |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z89) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |SelectionCriteria | | |*255* |*ST* |*R* |*Y* | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="21%,11%,6%,62%",options="header",]
|===
|Input Parameter (Query ID=Z89) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z89^Lab Results History^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|SelectionCriteria | |ST |A query expression whose operands are derived from the 'ColName' column in the 'Input Specification: Virtual Table' given below.
|===

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z89) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3: Patient Identifier List
|ResultReportTime.LL | | |26 |DTM |O | | | |OBR.22 | |OBR-22: Results rpt/status chng – date/time – lower limit
|ResultReportTime.UL | | |26 |DTM |O | | | |OBR.22 | |OBR-22: Results rpt/status chng – date/time – upper limit
|LabDept | | |80 |CWE |O |Y | |0074 |OBR.24 | |OBR-24: Diagnostic Serv Sect ID
|LOINCCode | | |80 |CWE |O |Y | | |OBX.3.4 | |OBX-3-4: Observation identifier – alternate identifier
|===

*Input Parameter Field Description and Commentary*

[width="100%",cols="19%,11%,6%,64%",options="header",]
|===
|Input Parameter (Query ID=Z89) |Comp. Name |DT |Description
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.)
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*Result Report Time.LL* | |DTM |The earliest date and time for which results are to be returned. If this field is not valued, the earliest results that conform to the other query parameters will be returned.
|*Result Report Time.UL* | |DTM |The latest date and time for which results are to be returned. If this field is not valued, the latest results that conform to the other query parameters will be returned.
|*LabDept* | |CWE |The section(s) or department(s) of the laboratory reporting the results. As many *LabDept* values may be specified as desired. If this field is not valued, results that conform to the other query parameters from all sections or departments will be returned.
|*LOINCCode* | |CWE |The LOINC identifier for the results to be reported. As many *LOINCCode* values may be specified as desired. If this field is not valued, results that conform to the other query parameters for all LOINC codes will be returned.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,26%,11%,6%,7%,37%",options="header",]
|===
|Field Seq (Query ID=Z89) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|7 |Segment group inclusion | |256 |ID |What segment group(s) are to be included. If this field is not valued, all segment groups will be included.
|===

If a LOINC code is used as one of the operands of the input specification expression, all of the other OBX segments which are part of the same OBR as the selected OBX will be returned along with the selected OBX. In other words, if an OBX segment that is part of a panel is selected by the query, the entire panel will be returned.

==== 5.9.2.5 Lab example different instantiation

The same Query Name might be invoked with a different query tag (456) as follows:

The user wishes to know all the lab results reported having a LOINC code of 6777-7 between March 21, 1999 and March 23, 1999.

MSH|^~\&|PCR|GenHosp|LIS||199907131040-0800||QBP^Z89^QBP_Z89|4495|D|2.8|

QPD|Z89^LabResultsHistory^HL7nnnn||@OBX.3.4^EQ^6777-7^AND|@OBR.22^GE^19990321^AND|@OBR.22^LE^19990323

RCP|I||R|

The second instance of the "Lab Results for Specified Criteria" query would clearly return quite different results than the first even though both are invocations of the same query.

=== 5.9.3 Query by parameter (QBP) / tabular response (RTB)

==== 5.9.3.0 hiddentext

==== 5.9.3.1 MPI example

The user wishes to know the identity of the patient whose medical record number is "555444222111".

MSH|^~\&|PCR|GenHosp|MPI||199811201400-0800||QBP^Z91^QBP_Q13|8699|P|2.8||||||||

QPD|Z91^WhoAmI^HL7nnnn|Q0009|555444222111^^^MPI^MR

RCP|I|999^RD|

RDF|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

The MPI system returns the following RTB message:

MSH|^~\&|MPI|GenHosp|PCR||199811201400-0800||RTB^Z92^RTB_K13|8699|P|2.8||||||||

MSA|AA|8699|

QAK|Q0009|OK|Z91^WhoAmI^HL7nnnn|1|

QPD|Z91^WhoAmI^HL7nnnn|Q0009|555444222111^^MPI^MR

RDF|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

RDT|555444222111^^^MPI^MR|Everyman^Adam||19600614|M||

===== 5.9.3.1.1 MPI Query Profile

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z89): |Z91
|Type: |Query
|Query Name: |Who Am I
|Query Trigger (= MSH-9): |QBP^Z91^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RTB^Z92^RTB_K13
|Query Characteristics: |
|Purpose: |Find the identity of the patient for specified medical record number(s)
|Response Characteristics: |
|Based on Segment Pattern: |
|===

The message structure for QBP^Z91^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Z92^RTB_K13: Response Grammar: Who Am I

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.7
|[\{ link:#RDT[RDT] }] |Table Row Data Segment | |5.5.8
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z91) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3: Patient Identifier List
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z91) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z91^Who Am I^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|PatientList | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) +
 +
If this field is not valued, all values for this field are considered to be a match. +
 +
If one PID.3 is specified, only 1 segment pattern will be returned.
| |ID |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |Assigning Authority |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |Identifier type code |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,13%,6%,7%,36%",options="header",]
|===
|Field Seq (Query ID=Z91) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z91) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3 Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|Mother'sMaidenName | | |48 |XPN | | | | |PID.6 | |PID-6 Mother's Maiden Name
|DOB | | |24 |DTM | | | | |PID.7 | |PID-7 Date/Time of Birth
|Sex | | |1 |CWE | | | | |PID.8 | |PID-8 Sex
|Race | | |80 |CWE | | | | |PID.10 | |PID-10 Race
|===

==== 5.9.3.2 Pharmacy example:

The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following QBP message is generated:

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Q42^QBP_Q13|8699|P|2.8||||||||

QPD|Q42^Tabular Dispense History^HL7nnn|Q0010|555444222111^^^MPI^MR| |19980531|19990531|

RDF|3|PatientList^ST^20~PatientName^XPN^48~MedicationDispensed^ST^40~RXD.3^DTM^24

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses meeting the criteria and returns the following RTB message:

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201400-0800||RTB^K42^RTB_K13|8858|P|2.8||||||||

MSA|AA|8699|

QAK|Q010|OK|Q42^Tabular Dispense History^HL7nnn|4

QPD|Q42^Tabular Dispense History^HL7nnn|Q0010|555444222111^^^MPI^MR||19980531|19990531|

RDF|7|PatientId^CX^20~PatientName^XPN^48~OrderControlCode^ID^2~ MedicationDispensed^CWE^100~DispenseDate^DTM^24~QuantityDispensed^NM^20~ OrderingProvider^XCN^120

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|525440345^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821-0700|100|77^Hippocrates^Harold^H^III^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00172409660^BACLOFEN 10MG TABS^NDC |199809221415-0700|10|88^Seven^Henry^^^DR^MD

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10|99^Assigned^Amanda^^^DR^MD

===== 5.9.3.2.1 QBP/RTB dispense history Query Profile

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z89): |Z93
|Type: |Query
|Query Name: |Tabular Dispense History
|Query Trigger (= MSH-9): |QBP^Z93^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RTB^Z94^RTB_K13
|Query Characteristics: |Returns response sorted by Date Dispensed unless otherwise specified.
|Purpose: |Find medications dispensed between specified date range for specified medical record numbers.
|Response Characteristics: |
|Based on Segment Pattern: |
|===

The message structure for QBP^Z93^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Z94^RTB_K13: Response Grammar: Who Am I

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.7
|[\{ link:#RDT[RDT] }] |Table Row Data Segment | |5.5.8
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z93) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3: Patient Identifier List
|4 |MedicationDispensed |S |Y |100 |CWE |O | |= | |RXD.2 | |RXD-2: Dispense/Give Code
|5 |DispenseDate.LL |S |Y |24 |DTM |O | |> +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|6 |DispenseDate.UL |S |Y |24 |DTM |O | |< +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z93) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z93^Tabular Dispense History^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|PatientList | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |ID |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |Assigning Authority |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |Identifier type code |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|MedicationDispensed | |CWE |If this field is not valued, all values for this field are considered to be a match.
|DispenseDate.LL | |DTM |This is the earliest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|DispenseDate.UL | |DTM |This is the latest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,13%,6%,7%,36%",options="header",]
|===
|Field Seq (Query ID=Z93) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z93) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3 Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|MedicationDispensed |S |Y |100 |CWE |O | |= | |RXD.2 | |RXD-2 Dispense/Give Code
|DispenseDate.LL |S |Y |24 |DTM |O | |>= | |RXD.3 | |RXD-3 Date/Time Dispensed
|DispenseDate.UL |S |Y |24 |DTM |O | |<= | |RXD.3 | |RXD-3 Date/Time Dispensed
|===

=== 5.9.4 Query using QSC variant / tabular response (RTB)

==== 5.9.4.0 hiddentext

==== 5.9.4.1 Pharmacy example

The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following message is generated:

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201400-0800||QBP^Z95^QBP_Q13|8699|P|2.8||||||||

QPD|Z95^Dispense Information^HL7nnnn|Q504 |PID.3^EQ^55544422211^AND~RXD.3^GE^19980531^AND~RXD.3^LE^19990531

RDF|3|PatientList^ST^20|PatientName^XPN^48|OrderControlCode^ID^2|OrderingProvider^XCN^120|MedicationDispensed^ST^40|DispenseDate^DTM^24|QuantityDispensed^NM^20|

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses meeting the criteria and returns the following RTB message:

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201400-0800||RTB^Z96^RTB_K13|8858|P|2.8||||||||

MSA|AA|8699|

QAK|Q001|OK|Z95^Dispense Information^HL7nnnn|4

QPD|Z95^Dispense Information^HL7nnnn|Q504 |PID.3^EQ^55544422211^AND~RXD.3^GE^19980531^AND~RXD.3^LE^19990531

RDF|3|PatientList^ST^20~PatientName^XPN^48~OrderControlCode^ID^2~OrderingProvider^XCN^120~MedicationDispensed^ST^40~DispenseDate^DTM^24~QuantityDispensed^NM^20|

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|77^Hippocrates^Harold^H^III^DR^MD |525440345^Verapamil Hydrochloride 120 mg TAB^NDC |199805291115-0700|100

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|77^Hippocrates^Harold^H^III^DR^MD |00182196901^VERAPAMIL HCL ER TAB 180MG ER^NDC |19980821-0700|100

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|88^Seven^Henry^^^DR^MD |00172409660^BACLOFEN 10MG TABS^NDC |199809221415-0700|10

RDT|555444222111^^^MPI^MR|Everyman^Adam|RE|99^Assigned^Amanda^^^DR^MD |00054384163^THEOPHYLLINE 80MG/15ML SOLN^NDC|199810121145-0700|10

===== 5.9.4.1.1 QBP/RTB dispense history Query Profile using QSC variant

Note that this Query Profile includes no separate Output Description and Commentary. In the QBP/RTB combination using the QSC variant, the selection criteria in _QPD-3-user parameters_ and the desired return data in _RDF-2-column description_ are constructed from the same Virtual Table, which appears in the Input Specification.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z95): |Z95
|Type: |Query
|Query Name: |Tabular Dispense History
|Query Trigger (= MSH-9): |QBP^Z95^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RTB^Z96^RTB_K13
|Query Characteristics: |Selection criteria are chosen from a Virtual Table. May specify patient, medication, and a date range.
|Purpose: |To retrieve patient pharmacy dispense history information from the Server.
|Response Characteristics: a|
Columns from the *Virtual Table* listed in the Input/Output Specification are specified for output in the RDF segment.

*If no columns are specified in the RDF segment, all columns will be returned.*

Response is sorted by Medication Dispensed unless otherwise specified in *SortControl.*

|Based on Segment Pattern: |
|===

The message structure for QBP^Z95^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Z96^RTB_K13: Response Grammar: Who Am I

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.7
|[\{ link:#RDT[RDT] }] |Table Row Data Segment | |5.5.8
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z95) |Field Description a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |SelectionCriteria | | |*255* |*ST* |*R* |*Y* | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z95) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z95^Tabular Dispense History^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|SelectionCriteria | |ST |A query expression whose operands are derived from the 'ColName' column in the 'Input/Output Specification: Virtual Table' given below.
|===

*Input/Output Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z95) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3 Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|OrderControlCode |S | |2 |ID | | | |0119 |ORC.1 | |ORC-1 Order Control
|MedicationDispensed |S |Y |100 |CWE | | | | |RXD.2 | |RXD-2 Dispense/Give Code
|DispenseDate |S | |24 |DTM | | | | |RXD.3 | |RXD-2 Date/Time Dispensed
|QuantityDispensed |L | |20 |NM | | | | |RXD.4 | |RXD-4 Actual Dispense Amount
|OrderingProvider |S | |120 |XCN | | | | |ORC.12 | |ORC-12 Ordering Provider
|===

*Virtual Table Field Description and Commentary*

[width="100%",cols="22%,10%,6%,62%",options="header",]
|===
|ColName (Query ID=Z95) |Comp. Name |DT |Description
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*PatientName* | |XPN |If this field, PID.5, is not valued, all values for this field are considered to be a match.
|*OrderControlCode* | |ID |If this field, ORC.1, is not valued, all values for this field are considered to be a match.
|*MedicationDispensed* | |CWE |If this field, RXD.2, is not valued, all values for this field are considered to be a match.
|*DispenseDate* | |DTM |If this field, RXD.3, is not valued, all values for this field are considered to be a match.
|*QuantityDispensed* | |NM |If this field, RXD.4, is not valued, all values for this field are considered to be a match.
|*OrderingProvider* | |XCN |If this field, ORC.12, is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,14%,7%,7%,34%",options="header",]
|===
|Field Seq (Query ID=Z95) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

=== 5.9.5 Query by parameter (QBP) / display response (RDY)

The user wishes to know all the medications dispensed for the patient whose medical record number is "555444222111" for the period beginning 5/31/98 and ending 5/31/99. The following QBP message is generated.

MSH|^~\&|PCR|Gen Hosp|PIMS||199909171400-0800||QBP^Z97^QBP_Q15|8699|P|2.8||||||||

QPD|Z97^DispenseHistoryDisplay^HL7nnnn|Q005|555444222111^^^MPI^MR||19980531|19990531|

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 4 prescription dispenses meeting the criteria and returns the following RDY message:

MSH|^~\&|PIMS|Gen Hosp|PCR||199909171401-0800||RDY^Z98^RDY_K15|8858|P|2.8||||||||

MSA|AA|8699|

QAK|Q005|OK|Z97^DispenseHistoryDisplay|4

QPD|Z97^DispenseHistoryDisplay^HL7nnnn|Q005|555444222111^^^MPI^MR||19980531|19990531|

DSP||| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:09-17-99

DSP||| DISPENSE HISTORY REPORT PAGE 1

DSP|||MRN Patient Name MEDICATION DISPENSED DISP-DATE

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL 120 mg TAB 05/29/1998

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL ER TAB 180MG 08/21/1998

DSP|||555444222111 Everyman,Adam BACLOFEN 10MG TABS 09/22/1998

DSP|||555444222111 Everyman,Adam THEOPHYLLINE 80MG/15ML SOL 10/12/1998

DSP||| << END OF REPORT >>

==== 5.9.5.0 hiddentext

==== 5.9.5.1 Dispense history display Query Profile

Note that this Query Profile includes no separate Output Description and Commentary. In Query Profiles that specify an RDY response message, the display format follows the response grammar.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z97): |Z97
|Type: |Query
|Query Name: |Dispense History
|Query Trigger (= MSH-9): |QBP^Z97^QBP_Q15
|Query Mode: |Both
|Response Trigger (= MSH-9): |RDY^Z98^RDY_K15
|Query Characteristics: |May specify patient, medication, a date range, and how the response is to be sorted.
|Purpose: |To retrieve patient pharmacy dispense history information from the Server.
|Response Characteristics: |Returns data formatted for screen display. Data are sorted by Medication Dispensed unless otherwise specified in *SortControl.*
|Based on Segment Pattern: |
|===

The message structure for QBP^Z97^QPB_Q15 can be found in 5.4.3. Use the QBP^Q15^QPB_Q15 Message structure.

RDY^Z98^RDY_K15: Response Grammar: Dispense History

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[\{ link:#DSP[DSP] }] |Display Data | |5.5.1
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="100%",options="header",]
|===
|The data will display as follows: (Query ID=Z97)
|DSP\|\|\| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:mm-dd-yy
|DSP\|\|\| DISPENSE HISTORY REPORT PAGE n
|DSP\|\|\|MRN Patient Name MEDICATION DISPENSED DISP-DATE
|DSP\|\|\|XXXXX XXXXXx, XXXXX XXXXXXXXXXXXXXXX mm/dd/ccyy
|...
|DSP\|\|\| << END OF REPORT >>
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z97) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3: Patient Identifier List
|4 |MedicationDispensed |S |Y |100 |CWE |O | |= | |RXD.2 | |RXD-2: Dispense/Give Code
|5 |DispenseDate.LL |S |Y |24 |DTM |O | |> +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|6 |DispenseDate.UL |S |Y |24 |DTM |O | |< +
= | |RXD.3 | |RXD-3: Date/Time Dispensed
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="22%,10%,6%,62%",options="header",]
|===
|Input Parameter (Query ID=Z97) |Comp. Name |DT |Description
|*MessageQueryName* | |CWE |SHALL be valued *Z97^Dispense History^HL7nnnn*.
|*QueryTag* | |ST |Unique to each query message instance.
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*MedicationDispensed* | |CWE |If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.LL* | |DTM |This is the earliest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|*DispenseDate.UL* | |DTM |This is the latest value to be returned for Date/Time Dispensed. If this field is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,26%,11%,6%,7%,37%",options="header",]
|===
|Field Seq (Query ID=Z97) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|===

=== 5.9.6 Query using QSC variant (QBP) / display response (RDY)

The user wishes to know all the medications ever dispensed for the patient whose medical record number is "555444222111" prescribed by Dr Lister (provider number 99). The following message is generated. (Note the similarity between the QPD segment here and that used in the query in Section 5.8.4.)

MSH|^~\&|PCR|Gen Hosp|PIMS||199811201300-0800||QBP^Z79^QBP_Q15|8698|P|2.8||||||||

QPD|Z79^Dispense Information^HL7nnnn|Q503 |PID.3^EQ^55544422211^AND|ORC.1^EQ^RE^AND|ORC.12.1^EQ^99

RCP|I|999^RD|

The pharmacy system identifies medical record number "555444222111" as belonging to Adam Everyman and locates 2 prescription dispenses as prescribed by Dr. Lister. The response is clearly different than the response to the first query.

MSH|^~\&|PIMS|Gen Hosp|PCR||199811201300-0800||RDY^Z80^RDY_K15|8857|P|2.8||||||||

MSA|AA|8698|

QAK|Q003|OK|Z79^Dispense Information^HL7nnnn|2

QPD|Z79^Dispense Information^HL7nnnn|Q503 |@PID.3^EQ^55544422211^AND~ORC.1^EQ^RE^AND~@RXD.3^GE^199711200000-0800^AND~@RXD.3^LE^199811200000-0800

DSP||| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:09-17-99

DSP||| DISPENSE HISTORY REPORT PAGE 1

DSP|||MRN Patient Name MEDICATION DISPENSED DISP-DATE

DSP|||555444222111 Everyman,Adam VERAPAMIL HCL 120 mg TAB 05/29/1998

DSP|||555444222111 Everyman,Adam THEOPHYLLINE 80MG/15ML SOL 10/12/1998

DSP||| << END OF REPORT >>

==== 5.9.6.0 

==== 5.9.6.1 Dispense history display Query Profile using QSC variant

Note that this Query Profile includes no separate Output Description and Commentary. In Query Profiles that specify an RDY response message, the display format follows the response grammar.

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z79): |Z79
|Type: |Query
|Query Name: |Dispense Information
|Query Trigger (= MSH-9): |QBP^Z79^QBP_Q15
|Query Mode: |Both
|Response Trigger (= MSH-9): |RDY^Z80^RDY_Z80
|Query Characteristics: |Selection criteria are chosen from a Virtual Table. May specify patient, order control code, medication, a date range, quantity dispensed, and ordering provider.
|Purpose: |To retrieve patient pharmacy dispense history information from the Server.
|Response Characteristics: |Returns data formatted for screen display. Data are sorted by Medication Dispensed unless otherwise specified in *SortControl.*
|Based on Segment Pattern: |
|===

The QBP_Q15 and RDY_K15 message structures and related choreography can be found in link:#qbprdy-query-by-parameterdisplay-response-events-vary[5.4.3].

RDY^Z80^RDY_Z80: Response Grammar: Dispense History

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[\{ link:#DSP[DSP] }] |Display Data | |5.5.1
|[ DSC ] |Continuation Pointer | |2.15.4
|===

[width="100%",cols="100%",options="header",]
|===
|The data will display as follows: (Query ID=Z79)
|DSP\|\|\| GENERAL HOSPITAL – PHARMACY DEPARTMENT DATE:mm-dd-yy
|DSP\|\|\| DISPENSE HISTORY REPORT PAGE n
|DSP\|\|\|MRN Patient Name MEDICATION DISPENSED DISP-DATE
|DSP\|\|\|XXXXX XXXXXx, XXXXX XXXXXXXXXXXXXXXX mm/dd/ccyy
|...
|DSP\|\|\| << END OF REPORT >>
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z79) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |ElementName
|1 |MessageQueryName | | |60 |CWE |R | | | | | |
|2 |QueryTag | | |32 |ST |R | | | | | |
|3 |SelectionCriteria | | |*255* |*ST* |*R* |*Y* | | | | |
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z79) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z79^Dispense Information^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|SelectionCriteria | |ST |A query expression whose operands are derived from the 'ColName' column in the 'Input/Output Specification: Virtual Table' given below.
|===

*Input Specification: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z79) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |ElementName
|PatientList |S |Y |20 |CX |O | | | |PID.3 | |PID-3: Patient Identifier List
|OrderControlCode |S | |2 |ID | | | |0119 |ORC.1 | |ORC-1 Order Control
|MedicationDispensed |S |Y |100 |CWE | | | | |RXD.2 | |RXD-2 Dispense/Give Code
|DispenseDate |S | |24 |DTM | | | | |RXD.3 | |RXD-2 Date/Time Dispensed
|QuantityDispensed |L | |20 |NM | | | | |RXD.4 | |RXD-4 Actual Dispense Amount
|OrderingProvider |S | |120 |XCN | | | | |ORC.12 | |ORC-12 Ordering Provider
|===

*Virtual Table Field Description and Commentary*

[width="100%",cols="22%,11%,6%,61%",options="header",]
|===
|ColName (Query ID=Z79) |Comp. Name |DT |Description
|*PatientList* | |CX |The combination of values for _PatientList.ID, and PatientList.AssigningAuthority,_ are intended to identify a unique entry on the PATIENT_MASTER table. The _PatientList.IdentifierTypeCode_ is useful for further filtering or to supply uniqueness in the event that the assigning authority may have more than one coding system. (The PATIENT_MASTER table contains a constraint that prevents multiple patients from being identified by the same combination of field values.) This PATIENT_MASTER entry will be searched against on the PHARMACY_DISPENSE_TRANSACTION table to retrieve the rows fulfilling the query conditions.
| | | |If this field is not valued, all values for this field are considered to be a match.
| | | |If one PID.3 is specified, only 1 segment pattern will be returned.
| |*ID* |ID |If this field, PID.3.1, is not valued, all values for this field are considered to be a match.
| |*Assigning Authority* |HD |If this field, PID.3.4, is not valued, all values for this field are considered to be a match.
| |*Identifier type code* |CWE |If this field, PID.3.5, is not valued, all values for this field are considered to be a match.
|*OrderControlCode* | |ID |If this field, ORC.1, is not valued, all values for this field are considered to be a match.
|*MedicationDispensed* | |CWE |If this field, RXD.2, is not valued, all values for this field are considered to be a match.
|*DispenseDate* | |DTM |If this field, RXD.3, is not valued, all values for this field are considered to be a match.
|*QuantityDispensed* | |NM |If this field, RXD.4, is not valued, all values for this field are considered to be a match.
|*OrderingProvider* | |XCN |If this field, ORC.12, is not valued, all values for this field are considered to be a match.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,14%,7%,7%,34%",options="header",]
|===
|Field Seq (Query ID=Z79) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

=== 5.9.7 +
Query by example (QBP) / tabular response (RTB)

This section demonstrates how to use a different syntax for passing query parameters to the query server. This syntactic variant is called "query by example" because, instead of passing query parameter as fields of the QBP segment, they are passed as fields of existing HL7 segments. Nevertheless, the Query Profile will clearly specify which fields of the HL7 segment can carry useful values. Note that both the QBP syntax and the "query by example" syntax have the same expressive power. Also note that when segments are used in the "query by example" variant, the required/optional characteristics of each field should be defined in the Query Profile, and that field optionality in queries may be different from the usual optionality of the segment when used in other HL7 messages.

This sample shows how the "query by example" might be used to find a list of candidates matching a set of demographics. Because demographic data is naturally carried by the existing PID segment, the message designer may, for stylistic or practical reasons, decide to pass the demographic parameters such as patient name or patient age in a PID segment.

The Client wishes to see a list of patients whose demographics are as follows:

Last Name: Nuclear +
First Name: Ned +
Sex: Male +
DOB: 12/11/48

The Client wishes to do this using the peekaboo algorithm with an 80% confidence level.

MSH|^~\&|PCR|GenHosp|MPI||199811201400-0800||QBP^Z77^QBP_Q13|8699|P|2.8||||||||

QPD|Z77^find_candidates^HL7nnnn|Q0001|peekaboo|80|

PID|||||Nuclear&Ned||19481211|M

RCP|I|25^RD|

RDF|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

The MPI system returns the following RTB message

**MSH**|^~\&|MPI|GenHosp|PCR||199811201400-0800||RTB^Z78^RTB_R13|8699|P|2.8||||||||

**MSA**|AA|8699|

**QAK**|

**QPD**|Z77^find_candidates^HL7nnnn|Q0001|peekaboo|80|

**RDF**|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

**RDT**|555444222111^^^MPI&KP.NCA&L^MR|Nuclear^Ned||19481211|M||

==== 5.9.7.0 hiddentext

==== 5.9.7.1 MPI Query Profile using QBE variant

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z77): |Z77
|Type: |Query
|Query Name: |Tabular Patient List
|Query Trigger (= MSH-9): |QBP^Z77^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RTB^Z78^RTB_K13
|Query Characteristics: a|
Query By Example: passes algorithm data via QBP segment and patient match information via PID segment.

Only PID fields listed in the QBE Input Parameter Specification may be populated to be matched against. Fields not populated will be considered as matching all returned records.

The PID segment is required for this query/response pattern.

Output columns are chosen from a Virtual Table.

|Purpose: |To find patient records that closely (as specified by the Client) match a set of input criteria using a specified algorithm.
|Response Characteristics: |Response returns requested columns from the Virtual Table. If no columns were requested, all columns are returned.
|Based on Segment Pattern: |
|===

The message structure for QBP^Z77^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Z78^RTB_K13: Response Grammar: Who Am I

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.7
|[\{ link:#RDT[RDT] }] |Table Row Data Segment | |5.5.8
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z77) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|1 |MessageQueryName | | |60 |CWE |R | | | | | |Message Query Name
|2 |QueryTag | | |32 |ST |R | | | | | |Query Tag
|3 |Algorithm | | |*48* |*ST* | | | | | | |Algorithm
|4 |ConfidenceLevel | | |8 |NM | | | | | | |Confidence Level
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z77) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z77^Tabular Patient List^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|Algorithm | |ST |The name of the search algorithm that is used to look up the parameter values specified in the PID segment.
|ConfidenceLevel | |NM |The degree of accuracy that the search algorithm must achieve in order to score a "hit."
|===

*QBE Input Parameter Specification*

[width="99%",cols="16%,13%,8%,6%,5%,7%,5%,5%,7%,5%,9%,14%",]
|===
|Segment Field Name (Query ID=Z77) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Service Identifier Code |Element Name
|PID.5 |PatientName |*S* | |48 |XPN | | | | | |PID-5-Patient Name
|PID.7 |DOB |*S* | |24 |DTM | | | | | |PID-7-Date/time of Birth
|PID.8 |Sex |S | |1 |CWE | | | | | |PID-8-Sex
|===

*QBE Input Parameter Field Description and Commentary*

[width="100%",cols="17%,10%,7%,66%",]
|===
|Input Parameter (Query ID=Z77) |Comp. Name |DT |Description
|PatientName | |XPN |Name of the patient. May be specified in full or in part.
|DOB | |DTM |Date and time of the patient's birth. Year, month, and day SHALL be specified; time is optional.
|Sex | |CWE |Administrative gender of the patient.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,13%,6%,7%,36%",options="header",]
|===
|Field Seq (Query ID=Z77) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z77) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3 Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|MothersMaidenName | | |48 |XPN | | | | |PID.6 | |PID-6 Mother's Maiden Name
|DOB | | |24 |DTM | | | | |PID.7 | |PID-7 Date/Time of Birth
|Sex | | |1 |CWE | | | | |PID.8 | |PID-8 Sex
|Race | | |80 |CWE | | | | |PID.10 | |PID-10 Race
|===

The same query as described above could be sent as a pure Query by Parameter query, without the "query by example" variant, as follows.

Notice that the query uses only a single QPD segment to carry all the parameters. The response to the query is the same as for the "query by example" variant above.

Example: the Client wishes to do this using the peekaboo algorithm with an 80% confidence level.

MSH|^~\&|PCR|GenHosp|MPI||199811201400-0800||QBP^Z75^QBP_Q13|8699|P|2.8||||||||

QPD|Z75^find_candidates^HL7nnnn|Q0001|peekaboo|80|Nuclear^Ned|19481211|M

RDF|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

RCP|I|999^RD|

The MPI system returns the following RTB message:

**MSH**|^~\&|MPI|GenHosp|PCR||199811201400-0800||RTB^Z76^RTB_R13|8699|P|2.8||||||||

**MSA**|AA|8699|

**QAK**|

QPD|Z75^find_candidates^HL7nnnn|Q0001|peekaboo|80|Nuclear^Ned|19481211|M

**RDF**|PatientList^CX^20~PatientName^XPN^48~Mother'sMaidenName^XPN^48~DOB^DTM^24~Sex^IS^1~Race^CWE^80|

**RDT**|555444222111^^^MPI&KP.NCA&L^MR|Nuclear^Ned|19481211|M||

==== 5.9.7.2 MPI Query Profile – Non query by example version

Query Profile

[width="100%",cols="39%,61%",options="header",]
|===
|Query Statement ID (Query ID=Z75): |Z75
|Type: |Query
|Query Name: |Tabular Patient List
|Query Trigger (= MSH-9): |QBP^Z75^QBP_Q13
|Query Mode: |Both
|Response Trigger (= MSH-9): |RTB^Z76^RTB_K13
|Query Characteristics: |Patient identifier and matching algorithm requirements are passed via the input parameters. Output columns are chosen from a Virtual Table.
|Purpose: |To find patient records that closely (as specified by the Client) match a set of input criteria using a specified algorithm.
|Response Characteristics: |Response returns requested columns from the Virtual Table. If no columns were requested, all columns are returned.
|Based on Segment Pattern: |
|===

The message structure for QBP^Z75^QPB_Q13 can be found in 5.3.1.2. Use the QBP^Q13^QPB_Q13 Message structure.

RTB^Z76^RTB_K13: Response Grammar: Who Am I

[width="100%",cols="33%,47%,9%,11%",options="header",]
|===
|Segments |Description |Status |Sec Ref
|MSH |Message Header | |2.15.9
|[\{SFT}] |Software Segment | |2.15.12
|[ UAC ] |User Authentication Credential | |2.14.13
|MSA |Message Acknowledgement | |2.15.8
|[ERR] |Error | |2.15.5
|link:#QAK[QAK] |Query Acknowledgement | |5.5.2
|link:#QPD[QPD] |Query Parameter Definition | |5.5.4
|[ |--- ROW_DEFINITION begin | |
|link:#RDF[RDF] |Table Row Definition Segment | |5.5.7
|[\{ link:#RDT[RDT] }] |Table Row Data Segment | |5.5.8
|] |--- ROW_DEFINITION end | |
|[ DSC ] |Continuation Pointer | |2.15.4
|===

*QPD Input Parameter Specification*

[width="100%",cols="11%,14%,8%,3%,6%,8%,3%,3%,8%,8%,9%,8%,11%",options="header",]
|===
|Field Seq (Query ID=Z75) |Name a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element
|1 |MessageQueryName | | |60 |CWE |R | | | | | |Message Query Name
|2 |QueryTag | | |32 |ST |R | | | | | |Query Tag
|3 |Algorithm | | |*48* |*ST* | | | | | | |Algorithm
|4 |ConfidenceLevel | | |8 |NM | | | | | | |Confidence Level
|5 |PatientName |S | |48 |XPN | | | | |PID.5 | |PID-5-Patient Name
|6 |DOB |S | |24 |DTM | | | | |PID.7 | |PID-7-Date/Time of Birth
|7 |Sex |S | |1 |CWE | | | | |PID.8 | |PID-8-Sex
|===

*QPD Input Parameter Field Description and Commentary*

[width="100%",cols="20%,11%,6%,63%",options="header",]
|===
|Input Parameter (Query ID=Z75) |Comp. Name |DT |Description
|MessageQueryName | |CWE |SHALL be valued *Z75^Tabular Patient List^HL7nnnn*.
|QueryTag | |ST |Unique to each query message instance.
|Algorithm | |ST |The name of the search algorithm that is used to look up the parameter values specified in the PID segment.
|ConfidenceLevel | |NM |The degree of accuracy that the search algorithm must achieve in order to score a 'hit'.
|PatientName | |XPN |Name of the patient. May be specified in full or in part.
|DOB | |DTM |Date and time of the patient's birth. Year, month, and day SHALL be specified; time is optional.
|Sex | |CWE |Administrative gender of the patient.
|===

*RCP Response Control Parameter Field Description and Commentary*

[width="100%",cols="13%,25%,13%,6%,7%,36%",options="header",]
|===
|Field Seq (Query ID=Z75) |Name |Com­po­nent Name |LEN |DT |Description
|1 |Query Priority | |1 |ID |(*D*)eferred or (*I*)mmediate. Default is *I*.
|2 |Quantity Limited Request | |10 |CQ |
| | |Quantity | |NM |Number of units (specified by the following component) that will be returned in each increment of the response. If no value is given, the entire response will be returned in a single increment.
| | |Units | |CWE |**CH**aracters, **LI**nes, **P**a**G**es, or **R**ecor**D**s. Default is *LI*.
|3 |Response Modality | |60 |CWE |**R**eal time or **B**atch. Default is *R*.
|6 |Sort-by Field | |256 |SRT |
| | |Sort-by Field | |ST |Segment field name of an output column by which the response may be sorted. SHALL contain a *Y* in the Sort column of the output specification table.
| | |Sequencing | |ID |As specified in HL7 Table 0397- Sequencing. Default is **A**scending.
|===

*Output Specification and Commentary: Virtual Table*

[width="99%",cols="19%,9%,3%,6%,8%,3%,6%,8%,8%,10%,11%,9%",options="header",]
|===
|ColName (Query ID=Z75) a|
Key/

Search

|Sort |LEN |TYPE |Opt |Rep |Match Op |TBL |Segment Field Name |Service Identifier Code |Element Name
|PatientList |*S* |*Y* |*20* |*CX* |*O* | | | |PID.3 | |PID-3 Patient Identifier List
|PatientName | | |48 |XPN | | | | |PID.5 | |PID-5 Patient Name
|MothersMaidenName | | |48 |XPN | | | | |PID.6 | |PID-6 Mother's Maiden Name
|DOB | | |24 |DTM | | | | |PID.7 | |PID-7 Date/Time of Birth
|Sex | | |1 |CWE | | | | |PID.8 | |PID-8 Sex
|Race | | |80 |CWE | | | | |PID.10 | |PID-10 Race
|===

== 5.10 SUPERSEDED QUERY/RESPONSE TRIGGER EVENTS AND MESSAGE PAIRS

*If the reader is defining a new query, please refer to the new recommended query/response pairs defined in section* _5.4_*, "*_QUERY/RESPONSE MESSAGE PAIRS_*." This section is retained for backward compatibility and the framework for the existing functional queries.*

=== 5.10.1 Display message

*The UDM message does not have a direct replacement in the new methodology.*

If the reader is defining a new query, please refer to the new recommended query/response pairs defined in section _5.3.3.4_. *_This section is retained for backward compatibility as of v 2.4 and withdrawn as of v 2.7._* See section _5.4_, "_QUERY/RESPONSE MESSAGE PAIRS_," for current query/response pairs.hiddentext

==== 

=== 5.10.2 Original mode queries

If the reader is defining a new query, please refer to the new recommended query/response pairs defined in section _5.3.3.4_. *_This section is retained for backward compatibility as of v 2.4 and withdrawn as of v 2.7._* See section _5.4_, "_QUERY/RESPONSE MESSAGE PAIRS_," for current query/response pairs.

== 5.11 OUTSTANDING ISSUES

It is not clear that there is a good use case for the super segment pattern as described in the example in section _5.9.1.2.1_, "_Comprehensive pharmacy information Query Profile_."

As currently written the usage and naming of segment groups is not clear:

____
{empty}1. Can a segment group name refer to more than one structure?

{empty}2. Can the same structure have more than one segment group name?
____

This has implications for table 0391, the segment group table, which is an itemization of the segment group names.
